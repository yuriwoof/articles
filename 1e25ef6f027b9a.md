---
title: "Azure で Sorry ページの実装"
emoji: "🙏"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Azure", "Azure Blob Storage", "Azure Functions"]
published: false
---

Sorry ページとは、Web サイトで障害やメンテナンスが発生した際に、ユーザーに対して状況を伝えるためのお詫びページです。
これは、Web サーバーのエラー画面ではソフトウェアのバージョン情報など攻撃者に知られたくない情報が含まれてしまうことがあるため、このようなページを用意しておきます。また、構築や管理に手間がかかりすぎるのも好ましくありません。

![alt text](/images/1e25ef6f027b9a/sorry1.png)

## Azure での Sorry ページの実装

Azure では、以下のような方法で Sorry ページを実装できます。方法 1 の Blob ストレージを利用するパターンが一番安価で簡単ですが、この後述べるような問題点があります。

|実現方法|説明|
|---|---|
|**方法 1: Blob ストレージで静的 Webページのホスティング**|Blob ストレージを使用して静的な Sorry ページをホストする方法。簡単にセットアップ可能[^1]|
|**方法 2: Azure Functions**|Azure Functions を使用して動的な Sorry ページを提供する方法|

この他に App Service や Application Gateway のカスタムエラーページの機能がありますが、これらは既定のエラーページを用意するためのものであり、Sorry ページを提供する用途にはあまり適していません [^2] [^3]。

## 方法1: Blob ストレージで静的 Webページのホスティング

では、Blob ストレージで Sorry ページをホストする方法を見てみましょう。

1. Azure ポータル → リソースの作成 → ストレージアカウント を選択
2. 基本 タブで以下を設定：
   - サブスクリプション: 任意
   - リソースグループ: `rg-sorry`
   - ストレージアカウント名: `stfddlabsorry<任意の文字列>`（この名前を控えておく）
   - リージョン: Japan East（Web サービスをホストするリージョンとは別リージョンが推奨）
   - パフォーマンス: Standard
   - 冗長性: ローカル冗長ストレージ (LRS)
3. 確認および作成 → 作成
4. ストレージアカウント → データ管理 → 静的 Web サイト → 有効を選択し保存
5. インデックスドキュメント名に `503.html` と入力し保存
6. コンテナー → $web → アップロードから `503.html` をアップロード

503.html の内容は以下のようにします。

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Service Unavailable</title>
    <style>
        body { font-family: Arial; text-align: center; padding: 50px; background: #FF9800; color: white; }
        h1 { font-size: 3em; }
    </style>
</head>
<body>
    <h1>SORRY</h1>
    <p>現在サービスを一時停止しています</p>
    <p>しばらくお待ちください</p>
</body>
</html>
```

7. Web ブラウザを開いて、以下の URL にアクセスして動作確認しましょう。
これで Sorry ページが表示されるはずです。

```
https://<ストレージ アカウント名>.z11.web.core.windows.net/
```

ただ、問題はこの方法では HTTP ステータスコードが 200 OK で返されてしまうことです。
これは当たり前で、静的 Web サイトのインデックスドキュメントは正常に取得できた場合 200 OK で返されるためです。

![alt text](/images/1e25ef6f027b9a/sorry2.png)

404 エラーページは用意できますが、ステータスコードのカスタマイズ性がないため、Sorry ページの用途としては実用的ではありません。

## 方法2: Azure Functions

それでは、次に Azure Functions を使って Sorry ページを提供してみます。

> ポイント: フレックス従量課金プランでは Azure ポータルから直接関数を作成・編集できないため、VS Code を使用してデプロイします。

### 関数アプリの作成

1. Azure ポータル → リソースの作成 → 関数アプリ を選択
2. "フレックス従量課金" プランを選択し、"選択" をクリック
3. 基本 タブで以下を設定：
   - サブスクリプション: 任意
   - リソースグループ: `rg-sorry`
   - 関数アプリ名: `func-sorry-<任意の文字列>`（この名前を控えておく）
   - リージョン: Japan East（Web サービスをホストするリージョンとは別リージョンが推奨）
   - ランタイム スタック: Node.js
   - バージョン: 22 LTS
   - インスタンスサイズ: 512 MB
4. 確認および作成 → 作成

### Visual Studio Code の準備

ここからの前提として Visual Studio Code (以降、VS Code) を使用します。
インストール方法は公式サイトを参照してください[^4]。

1. VS Code に以下の拡張機能をインストール：
   - Azure Functions（Microsoft 製）

2. VS Code で Azure にサインイン：
   - `Ctrl + Shift + P` → "Azure: Sign In" を選択
   - ブラウザでサインインを完了

### Azure Functions Core Tools のインストール

Azure Functions をローカルで開発・デプロイするために、Azure Functions Core Tools をインストールします[^5]。
ここでは、WSL2 を前提にしているため、Linux 向けのインストール方法を記載します。

Linux（AMD64）:

```bash
# Microsoft パッケージリポジトリの追加
$ curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
$ sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
$ sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'

# インストール
$ sudo apt-get update
$ sudo apt-get install azure-functions-core-tools-4
```

Linux（ARM64）:

> ポイント: apt パッケージは amd64 のみ対応のため、ARM64 環境（Raspberry Pi、Apple Silicon 上の Linux VM 等）では npm 経由でインストールします。npm を使用するには Node.js が必要です。

```bash
# 1. Node.js のインストール（未インストールの場合）
$ curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
$ sudo apt-get install -y nodejs

# 2. Azure Functions Core Tools をインストール
$ sudo npm install -g azure-functions-core-tools@4 --unsafe-perm true
```

インストール確認:
```bash
$ func --version
```

### ローカルで関数プロジェクトを作成

VS Code の Azure Functions 拡張機能を使用してプロジェクトを作成する [^6] か、
以下のようにターミナルで Azure Functions Core Tools を使用してプロジェクトを作成します。

1. ターミナルで作業フォルダを作成：

```bash
$ mkdir func-sorry && cd func-sorry
```

2. Azure Functions Core Tools で初期化：

```bash
$ func init --javascript --model V3
```

3. HTTP トリガー関数を作成：

```bash
$ func new --name sorry --template "HTTP trigger" --authlevel anonymous
```

### 関数コードの編集

1. `sorry/index.js` を以下の内容に置き換え：

ここでは、HTML ページと併せて HTTP ステータスコード 503 Service Unavailable を返すようにします。
このように、返却するステータスコードをカスタマイズ可能です。

```javascript
module.exports = async function (context, req) {
    const html = `<!DOCTYPE html>
<html>
<head>
    <title>Service Unavailable</title>
    <style>
        body { font-family: Arial; text-align: center; padding: 50px; background: #FF9800; color: white; }
        h1 { font-size: 3em; }
    </style>
</head>
<body>
    <h1>SORRY</h1>
    <p>現在サービスを一時停止しています</p>
    <p>しばらくお待ちください</p>
    <p>Time: ${new Date().toISOString()}</p>
</body>
</html>`;

    context.res = {
        status: 503,
        headers: {
            'Content-Type': 'text/html; charset=utf-8'
        },
        body: html
    };
};
```

2. `host.json` を編集し、`api` プレフィックスを除去：

デフォルトでは Azure Functions の HTTP トリガーは `/api/<関数名>` というパスで公開されます。これをルート ( `/` ) に変更するには、`routePrefix` を空文字に設定します。

```json
{
  "version": "2.0",
  "logging": {
    "applicationInsights": {
      "samplingSettings": {
        "isEnabled": true,
        "excludedTypes": "Request"
      }
    }
  },
  "extensions": {
    "http": {
      "routePrefix": ""
    }
  },
  "extensionBundle": {
    "id": "Microsoft.Azure.Functions.ExtensionBundle",
    "version": "[4.*, 5.0.0)"
  }
}
```

3. `sorry/function.json` に `route` を追加し、すべてのパスで応答するように設定します。

```json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": [
        "get",
        "post"
      ],
      "route": "{*path}"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
```

> ポイント: `routePrefix` を空文字にし、`route` に `{*path}` を指定することで、関数がルートパス `/` を含むすべてのパスで応答します。

4. （オプション）ローカルでテスト：

```bash
$ func start
```

ブラウザで `http://localhost:7071/` にアクセスして動作確認しましょう。下記のように 503 Service Unavailable ステータスコードで Sorry ページが表示されるはずです。

![alt text](/images/1e25ef6f027b9a/sorry3.png)

### Azure にデプロイ

ここも VS Code の Azure Functions 拡張機能を使用してデプロイする方法と、Azure Functions Core Tools を使用してコマンドラインからデプロイする方法の2通りがあります。
ここでは、コマンドラインからデプロイする方法を紹介します。

```bash
$ func azure functionapp publish func-sorry-<任意の文字列>
```

実行例はこちら

```bash
yurio@laptopyo:~/func-sorry$ func azure functionapp publish func-sorry-yuo
'local.settings.json' found in root directory (/home/yurio/func-sorry).
Resolving worker runtime to 'node'.
Getting site publishing info...
[2026-02-06T14:42:45.763Z] Starting the function app deployment...
[2026-02-06T14:42:45.770Z] Creating archive for current directory...
Uploading 1.33 KB [###############################################################################]
Deployment in progress, please wait...
Starting deployment pipeline.
...(省略)...
[2026-02-06T14:44:57.158Z] The deployment was successful!
Functions in func-sorry-yuo:
    sorry - [httpTrigger]
        Invoke url: <アクセス可能な URL>

yurio@laptopyo:~/func-sorry$ 
```

デプロイの最後に表示される URL にアクセスして、Azure 上での動作を確認しましょう。

## まとめ

Azure で Sorry ページを実装する 2 つの方法を紹介しました。それぞれの特徴を比較すると以下のとおりです。

| |方法 1: Blob ストレージ|方法 2: Azure Functions|
|---|---|---|
|**セットアップの容易さ**|簡単（ポータル操作のみ）|やや手間（VS Code + Core Tools が必要）|
|**HTTP ステータスコード**|200 OK 固定（カスタマイズ不可）|任意のコードを返却可能（503 等）|
|**コスト**|非常に安価（ストレージ料金のみ）|安価（フレックス従量課金で未使用時はほぼ無料）|
|**動的コンテンツ**|不可（静的 HTML のみ）|可能（時刻表示やリクエスト情報の埋め込み等）|
|**用途**|簡易的な告知ページ|ステータスコードの制御が必要な本番用途|

Sorry ページとしてステータスコード 503 を返す必要がある場合は **方法 2: Azure Functions** となるでしょう。一方で単に告知を表示できれば十分な場合は **方法 1: Blob ストレージ** が最も手軽です。

また、コンテナや VM を使う方法も考えられますが、コストが他と比べてかかるため本記事では割愛しています。

[^1]: [Azure Storage で静的 Web サイトをホストする](https://learn.microsoft.com/ja-jp/azure/storage/blobs/storage-blob-static-website-how-to?tabs=azure-portal)
[^2]: [Azure App Service でカスタムエラーページを構成する](https://learn.microsoft.com/ja-jp/azure/app-service/configure-custom-error-pages)
[^3]: [Azure Application Gateway でカスタムエラーページを構成する](https://learn.microsoft.com/ja-jp/azure/application-gateway/custom-error-pages)
[^4]: [Visual Studio Code のダウンロード](https://code.visualstudio.com/download)
[^5]: [Azure Functions Core Tools のインストール](https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-run-local?tabs=linux%2Cisolated-process%2Cnode-v4%2Cpython-v2%2Chttp-trigger%2Ccontainer-apps&pivots=programming-language-javascript#install-the-azure-functions-core-tools)
[^6]: [VS Code で Azure Functions プロジェクトを作成する](https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-develop-vs-code?tabs=nodejs)