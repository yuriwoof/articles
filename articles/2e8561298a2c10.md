---
title: "AKS + AGIC ã§ TLS çµ‚ç«¯ã‚’è¡Œã†"
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Azure", "Kubernetes", "AKS", "Application Gateway"]
published: false
---

å€‹äººçš„ãªè¨­å®šæ–¹æ³•ã®ãƒ¡ãƒ¢ã¨ã—ã¦æ›¸ãæ•£ã‚‰ã—ã¦ãŠãã¾ã™ã€‚

## å‰æ

* Azure Kubernetes Service (AKS) ãŒæ—¢ã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨
* Application Ingress Controller (AGIC) ãŒæ—¢ã«æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨
* Azure Key Vault ãŒæ—¢ã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨
* TLS è¨¼æ˜æ›¸ã¯ã€è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

## æ‰‹é †

åˆã‚ã« TLS è¨¼æ˜æ›¸ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```bash
$ mkdir aks-agic-tls
$ cd aks-agic-tls/
$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -out aks-ingress-tls.crt -keyout aks-ingress-tls.key -subj "/CN=demo.yuohno.com/O=aks-ingress-tls"
$ ls -l
total 8
-rw-r--r-- 1 yurio yurio 1200 Nov 28 16:45 aks-ingress-tls.crt
-rw------- 1 yurio yurio 1704 Nov 28 16:45 aks-ingress-tls.key
```

æ¬¡ã« Azure Key Vault ã§æ‰±ã†è¨¼æ˜æ›¸ã¯ã€[PFX å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹](https://learn.microsoft.com/ja-jp/azure/key-vault/certificates/faq#azure-key-vault---------------------------) ãŸã‚ã€PFX å½¢å¼ã«å¤‰æ›ã—ã¾ã™ã€‚
ã¾ãŸã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚

```bash
$ openssl pkcs12 -export -in aks-ingress-tls.crt -inkey aks-ingress-tls.key -out aks-ingress-cert.pfx
Enter Export Password:
Verifying - Enter Export Password:
$ ls -l
total 12
-rw------- 1 yurio yurio 2595 Nov 28 16:46 aks-ingress-cert.pfx
-rw-r--r-- 1 yurio yurio 1200 Nov 28 16:45 aks-ingress-tls.crt
-rw------- 1 yurio yurio 1704 Nov 28 16:45 aks-ingress-tls.key
```

ä¸Šè¨˜ã§ç”Ÿæˆã—ãŸ PFX ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Azure Key Vault ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
"ã‚­ãƒ¼ ã‚³ãƒ³ãƒ†ãƒŠãƒ¼è¨¼æ˜æ›¸è²¬ä»»è€…" ãªã©ã€è¨¼æ˜æ›¸ã®æ“ä½œæ¨©é™ã‚’æŒã¤ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦ãŒå¿…è¦ã§ã™ã€‚


```bash
$ az keyvault certificate import --vault-name $AKV_NAME --name aks-ingress-cert --file ./aks-ingress-cert.pfx
```

ãã‚Œã§ã¯ Kubernete ã®æ“ä½œã«ç§»ã‚Šã¾ã™ã€‚

### SecretProviderClass ã®ä½œæˆ

AKS ã«ã¦ã€Secrets Store CSI ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²ã‚Šå½“ã¦ ãƒãƒãƒ¼ã‚¸ãƒ‰ ID ãŒä½œã‚‰ã‚Œã¾ã™ã®ã§ã€
ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã‚’æ§ãˆã¦ãŠãã¾ã™ã€‚

![alt text](/images/2e8561298a2c10/image.png)

```bash
$ kubectl create namespace ingress
$ export CERT_NAME=aks-ingress-cert
$ export AKV_NAME=<Azure Key Vault å>
$ export TENANT_ID=<MS Entra ID ãƒ†ãƒŠãƒ³ãƒˆ ID>
$ export CLIENT_ID=<ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²ã‚Šå½“ã¦ ãƒãƒãƒ¼ã‚¸ãƒ‰ ID ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID>
$ cat << EOF | kubectl apply -n ingress -f -
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-tls
spec:
  provider: azure
  secretObjects:
    - secretName: ingress-tls-csi
      type: kubernetes.io/tls
      data: 
        - objectName: $CERT_NAME
          key: tls.key
        - objectName: $CERT_NAME
          key: tls.crt
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: $CLIENT_ID
    keyvaultName: $AKV_NAME
    objects: |
      array:
        - |
          objectName: $CERT_NAME
          objectType: secret
    tenantId: $TENANT_ID
EOF
```

ãã‚Œã§ã¯ã€ã“ã®è¨¼æ˜æ›¸ã‚’ä½¿ã£ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ã—ã¾ã™ã€‚
ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ã€ä¸Šè¨˜ã§ ```secrets-store-inline``` ã®ç®‡æ‰€ã§ã€ä¸€åº¦ Secret ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒˆã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€Secret ãŒä½œæˆã•ã‚Œã€ãã®å¾Œã® Ingress ã‹ã‚‰å‚ç…§å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

> [Known Limitations - Secrets Store CSI Driver](https://secrets-store-csi-driver.sigs.k8s.io/known-limitations#mounted-content-and-kubernetes-secret-not-updated)
>
> The CSI driver is invoked by kubelet only during the pod volume mount. 

```bash
$ cat << EOF | kubectl apply -n ingress -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aks-helloworld  
spec:
  replicas: 1
  selector:
    matchLabels:
      app: aks-helloworld
  template:
    metadata:
      labels:
        app: aks-helloworld
    spec:
      containers:
      - name: aks-helloworld-one
        image: mcr.microsoft.com/azuredocs/aks-helloworld:v1
        ports:
        - containerPort: 80
        env:
        - name: TITLE
          value: "Welcome to Azure Kubernetes Service (AKS)"
        volumeMounts:
        - name: secrets-store-inline
          mountPath: "/mnt/secrets-store"
          readOnly: true
      volumes:
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: "azure-tls"
---
apiVersion: v1
kind: Service
metadata:
  name: aks-helloworld
spec:
  type: ClusterIP
  ports:
  - port: 80
  selector:
    app: aks-helloworld
EOF
```

ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ãŒç¨¼åƒã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã€ok ã§ã™ã­ã€‚

```bash
$ kubectl get deploy -n ingress
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
aks-helloworld   1/1     1            1           28s
```

æ¬¡ã« Ingress ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ cat << EOF | kubectl apply -n ingress -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-tls
spec:
  ingressClassName: azure-application-gateway
  tls:
  - hosts:
    - demo.yuohno.com
    secretName: ingress-tls-csi
  rules:
  - host: demo.yuohno.com
    http:
      paths:
      - path: /
        pathType: Exact
        backend:
          service:
            name: aks-helloworld
            port:
              number: 80
EOF
```

æœ€å¾Œã«ã€Ingress ãƒªã‚½ãƒ¼ã‚¹ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ã€curl ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ kubectl get ingress -n ingress
NAME          CLASS                       HOSTS             ADDRESS       PORTS     AGE
ingress-tls   azure-application-gateway   demo.yuohno.com   xxx.xxx.xxx.xxx   80, 443   10m
```

ä¸‹è¨˜ TLS è¨¼æ˜æ›¸ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¦ãŠã‚Šã€ä½œæˆã—ãŸè‡ªå·±è¨¼æ˜æ›¸ã® Common Name (```CN```) ãŠã‚ˆã³ Organization Name (```O```) ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
yurio@LAPTOP-SK5100ET:~/aks-agic-tls$ curl -v -k --resolve demo.yuohno.com:443:xxx.xxx.xxx.xxx https://demo.yuohno.com
* Added demo.yuohno.com:443:xxx.xxx.xxx.xxx to DNS cache
* Hostname demo.yuohno.com was found in DNS cache
*   Trying xxx.xxx.xxx.xxx :443...
* Connected to demo.yuohno.com (xxx.xxx.xxx.xxx) port 443

...(çœç•¥)...

* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384 / prime256v1 / rsaEncryption
* ALPN: server accepted http/1.1
* Server certificate:
*  subject: CN=demo.yuohno.com; O=aks-ingress-tls
*  start date: Nov 28 07:45:49 2024 GMT
*  expire date: Nov 28 07:45:49 2025 GMT
*  issuer: CN=demo.yuohno.com; O=aks-ingress-tls
*  SSL certificate verify result: self-signed certificate (18), continuing anyway.
*   Certificate level 0: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption

...(çœç•¥)...

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link rel="stylesheet" type="text/css" href="/static/default.css">
    <title>Welcome to Azure Kubernetes Service (AKS)</title>

    <script language="JavaScript">
        function send(form){
        }
    </script>

</head>
<body>
    <div id="container">
        <form id="form" name="form" action="/"" method="post"><center>
        <div id="logo">Welcome to Azure Kubernetes Service (AKS)</div>
        <div id="space"></div>
        <img src="/static/acs.png" als="acs logo">
        <div id="form">      
        </div>
    </div>     
</body>
* Connection #0 to host demo.yuohno.com left intact
```

æœ€å¾Œã« Azure ãƒãƒ¼ã‚¿ãƒ«ã‚’é–‹ãã€Application Gateway ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã€TLS è¨¼æ˜æ›¸ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

![alt text](/images/2e8561298a2c10/image-1.png)
![alt text](/images/2e8561298a2c10/image-2.png)

ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã—ãŸã­ã€‚
ã¨ã„ã†ã“ã¨ã§æ¤œè¨¼ã¯ä»¥ä¸Šã§ã™ã€‚