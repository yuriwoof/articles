---
title: "ハブスポーク構成でのハブ間疎通"
emoji: "🛞"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Azure","Azure Firewall"]
published: false
---

# はじめに

Azure に限らず、ネットワークモデルとして良く取られるものとして、"Hub & Spoke" ネットワークがあります。
これは、あたかもタイヤのハブ (軸) とスポーク (軸から延びる腕の部分) があって、ハブ ネットワークにスポーク ネットワークから共有されるサービを集約するといった形態のネットワークです。
この記事では、Hub & Spoke ネットワーク構成を取った際、良くトピックとして挙げられるスポーク ネットワーク間の疎通について、Azure での実現方法を確認していきます。

なお、[こちら](https://learn.microsoft.com/ja-jp/azure/architecture/networking/guide/spoke-to-spoke-networking) が詳しいです。

# スポーク ネットワーク間通信

スポーク ネットワークは、ワークロード毎に分けるように作ることが多く、そのため、スポーク ネットワークに閉じた通信が主なものとなります。
一方、ワークロード間など特定の通信が必要になるケースがあり、その場合においてスポーク ネットワーク間の通信を設計します。

なお、Azure においては Hub & Spoke ネットワークの実現方法として、以下の２通りの方法がありますが、
Virtual WAN を利用する場合、構成が楽な反面、きめ細かな制御ができないことがありますので、
２の方法で構成した場合の、スポーク間の疎通について実現方法を確認していきます。

1. [Virtual WAN を利用](https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/ready/azure-best-practices/virtual-wan-network-topology)
2. [仮想ネットワーク ピアリングで構成](https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/ready/azure-best-practices/traditional-azure-networking-topology)


# 構成

東日本、西日本でそれぞれ、Hub & Spoke 構成を取った場合の構成をしており、東西のハブ ネットワークを経由して接続されています。
ただし、仮想ネットワーク ピアリング (VNet ピアリング) は [推移的なルーティングをサポートしていない](https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-manage-peering?tabs=peering-portal#:~:text=%E3%83%94%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AF%202%20%E3%81%A4%E3%81%AE%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E9%96%93%E3%81%A7%E7%A2%BA%E7%AB%8B%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82%20%E3%83%94%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E8%87%AA%E4%BD%93%E3%81%AF%E6%8E%A8%E7%A7%BB%E7%9A%84%E3%81%A7%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82%20%E6%AC%A1%E3%81%AE%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E9%96%93%E3%81%AE%E3%83%94%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%81%A8%E3%81%97%E3%81%BE%E3%81%99%E3%80%82) ため、隣り合っていない VNet へのアクセスについては、
明示的なルーティングの設定が必要になります。

また、下部の運用 VNet は構成に必須ではなく、各スポーク ネットワークにあるワークロードの保守を行うためのものです。
今回は、仮想マシン VM-OPS から VM-01 に入り、疎通を確認しています。

![全体ネットワーク構成図](/images/8e4144734ec5b6/image.png)

# ① のネットワーク疎通について

仮想マシン ```VM-01``` から仮想マシン ```VM-02``` についての疎通を考えてみましょう。
まず、当初のネットワークの構成から、それぞれが所属する スポーク VNet #1 およびスポーク VNet #2 において、
ハブ (Azure Firewall) に対するユーザー定義ルートが設定されています。これによって、双方の VNet から通信は、ハブ VNet #1 の Azure Firewall を経由します。

![VM-01からVM-02への疎通](/images/8e4144734ec5b6/image-1.png)

ただし、上記にあったように、推移的なルーティングはサポートされていないため、
スポーク VNet #1 -> ハブ VNet #1 -> スポーク VNet #2 という通信は成り立ちません。
そこで、Azure Firewall ルールに以下のようなネットワーク ルールを設定することでその疎通が可能となります
(許可するプロトコルやポートは要件に合わせて要調整)。

|設定項目|ルール1|ルール2|
|-------|-------|-------|
|規則コレクションの種類|許可|許可|
|ソースの種類|IP アドレス|IP アドレス|
|ソース IP アドレス|10.1.0.0/16|10.2.0.0/16|
|宛先の種類|IP addresses|IP addresses|
|宛先 IP アドレス|10.2.0.0/16|10.1.0.0/16|
|プロトコル|任意|任意|
|ポート|*|*|

設定後、疎通できることを確認します。

![VM-01からVM-02への疎通確認](/images/8e4144734ec5b6/image-2.png)

# ② のネットワーク疎通について

次に、仮想マシン ```VM-01``` から仮想マシン ```VM-03``` についての疎通を考えてみましょう (仮想マシン ```VM-04``` も同じ考え方)。

![VM-01からVM-03への疎通](/images/8e4144734ec5b6/image-3.png)

先の場合と同様に、Azure Firewall のネットワーク ルールに対して、
スポーク VNet #3 のルールを設定します (カンマ区切りで複数の IP アドレスを指定することができます)。

|設定項目|ルール3|ルール4|
|-------|-------|-------|
|規則コレクションの種類|許可|許可|
|ソースの種類|IP アドレス|IP アドレス|
|ソース IP アドレス|10.1.0.0/16,10.2.0.0/16|192.168.3.0/24,192.168.4.0/24|
|宛先の種類|IP addresses|IP addresses|
|宛先 IP アドレス|192.168.3.0/24,192.168.4.0/24|10.1.0.0/16,10.2.0.0/16|
|プロトコル|任意|任意|
|ポート|*|*|

ただ、このままでは Azure Firewall からインターネットへの疎通が試行されてしまうため、
スポーク VNet #3 とのルーティングを管理するハブ VNet #2 の Azure Fireweall (azfw2) に振り向けなくてななりません。

そのため、```azfw1``` がある AzureFirewallSubnet に対して、以下のユーザー定義ルートを関連付けます。
これによって、スポーク VNet #3 およびスポーク VNet #4 へのトラフィックが ```azfw2``` に振り向けられます。

![HubVNET1のUDR](/images/8e4144734ec5b6/image-4.png)

また、戻りの通信のため、```azfw2``` のある AzureFirewallSubnet に対してもユーザー定義ルートが必要となります。
それはこちらになります。

![HubVNET2のUDR](/images/8e4144734ec5b6/image-5.png)

最後に、 ```azfw2``` の Azure Firewall ルールに対して、スポーク VNet #1 およびスポーク VNet #2 のルールを設定します。

|設定項目|ルール5|ルール6|
|-------|-------|-------|
|規則コレクションの種類|許可|許可|
|ソースの種類|IP アドレス|IP アドレス|
|ソース IP アドレス|10.1.0.0/16,10.2.0.0/16|192.168.3.0/24,192.168.4.0/24|
|宛先の種類|IP addresses|IP addresses|
|宛先 IP アドレス|192.168.3.0/24,192.168.4.0/24|10.1.0.0/16,10.2.0.0/16|
|プロトコル|任意|任意|
|ポート|*|*|

これで、スポーク VNet #1 からスポーク VNet #3 への疎通が可能となります。

![VM-01からVM-03への疎通確認](/images/8e4144734ec5b6/image-6.png)

:::message
今回の構成は、Azure Firewall からインターネットへの疎通は、許可していません。
必要な場合は、Azure Firewall のネットワーク ルール もしくはアプリケーション ルールを適切に設定してください。
:::

# まとめ

Hub & Spoke 構成において、Azure Firewall を使ってスポーク ネットワーク間の疎通を実現するための方法について確認しました。
これ以外にもスポーク ネットワーク間の必要な疎通が特定されているのであれば、そのスポーク ネットワーク間で VNet ピアリングを行う方が、
Azure Firewall を経由するよりも設定、性能面、コスト面でも最善かもしれませんので、併せて検討してみてください。

# 参考情報

* [Azure Firewall を使用してマルチ ハブ アンド スポーク トポロジをルーティングする](https://learn.microsoft.com/ja-jp/azure/firewall/firewall-multi-hub-spoke)
