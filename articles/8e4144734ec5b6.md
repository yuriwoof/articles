---
title: "ãƒãƒ–ã‚¹ãƒãƒ¼ã‚¯æ§‹æˆã§ã®ãƒãƒ–é–“ç–é€š"
emoji: "ğŸ›"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Azure","Azure Firewall"]
published: false
---

# ã¯ã˜ã‚ã«

Azure ã«é™ã‚‰ãšã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦è‰¯ãå–ã‚‰ã‚Œã‚‹ã‚‚ã®ã¨ã—ã¦ã€"Hub & Spoke" ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ã€ã‚ãŸã‹ã‚‚ã‚¿ã‚¤ãƒ¤ã®ãƒãƒ– (è»¸) ã¨ã‚¹ãƒãƒ¼ã‚¯ (è»¸ã‹ã‚‰å»¶ã³ã‚‹è…•ã®éƒ¨åˆ†) ãŒã‚ã£ã¦ã€ãƒãƒ– ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å…±æœ‰ã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚’é›†ç´„ã™ã‚‹ã¨ã„ã£ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å½¢æ…‹ã§ã™ã€‚
ã“ã®è¨˜äº‹ã§ã¯ã€Hub & Spoke ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã‚’å–ã£ãŸéš›ã€è‰¯ããƒˆãƒ”ãƒƒã‚¯ã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã‚‹ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã®ç–é€šã«ã¤ã„ã¦ã€Azure ã§ã®å®Ÿç¾æ–¹æ³•ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

ãªãŠã€Azure ã«ãŠã‘ã‚‹ã‚¹ãƒãƒ¼ã‚¯é–“ã®é€šä¿¡ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰](https://learn.microsoft.com/ja-jp/azure/architecture/networking/guide/spoke-to-spoke-networking) ã«è©³ã—ã„èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚

# ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“é€šä¿¡

ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰æ¯ã«åˆ†ã‘ã‚‹ã‚ˆã†ã«ä½œã‚‹ã“ã¨ãŒå¤šãã€ãã®ãŸã‚ã€ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é–‰ã˜ãŸé€šä¿¡ãŒä¸»ãªã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚
ä¸€æ–¹ã€ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰é–“ãªã©ç‰¹å®šã®é€šä¿¡ãŒå¿…è¦ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã€ãã®å ´åˆã«ãŠã„ã¦ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã®é€šä¿¡ã‚’è¨­è¨ˆã—ã¾ã™ã€‚

ãªãŠã€Azure ã«ãŠã„ã¦ã¯ Hub & Spoke ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å®Ÿç¾æ–¹æ³•ã¨ã—ã¦ã€ä»¥ä¸‹ã®ï¼’é€šã‚Šã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€
Virtual WAN ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€æ§‹æˆãŒæ¥½ãªåé¢ã€ãã‚ç´°ã‹ãªåˆ¶å¾¡ãŒã§ããªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã®ã§ã€
ï¼’ã®æ–¹æ³•ã§æ§‹æˆã—ãŸå ´åˆã®ã€ã‚¹ãƒãƒ¼ã‚¯é–“ã®ç–é€šã«ã¤ã„ã¦å®Ÿç¾æ–¹æ³•ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

1. [Virtual WAN ã‚’åˆ©ç”¨](https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/ready/azure-best-practices/virtual-wan-network-topology)
2. [ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ”ã‚¢ãƒªãƒ³ã‚°ã§æ§‹æˆ](https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/ready/azure-best-practices/traditional-azure-networking-topology)


# æ§‹æˆ

æ±æ—¥æœ¬ã€è¥¿æ—¥æœ¬ã§ãã‚Œãã‚Œã€Hub & Spoke æ§‹æˆã‚’å–ã£ãŸå ´åˆã®æ§‹æˆã‚’ã—ã¦ãŠã‚Šã€æ±è¥¿ã®ãƒãƒ– ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’çµŒç”±ã—ã¦æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™ã€‚
ãŸã ã—ã€ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ”ã‚¢ãƒªãƒ³ã‚° (VNet ãƒ”ã‚¢ãƒªãƒ³ã‚°) ã¯ [æ¨ç§»çš„ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„](https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-manage-peering?tabs=peering-portal#:~:text=%E3%83%94%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AF%202%20%E3%81%A4%E3%81%AE%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E9%96%93%E3%81%A7%E7%A2%BA%E7%AB%8B%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82%20%E3%83%94%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E8%87%AA%E4%BD%93%E3%81%AF%E6%8E%A8%E7%A7%BB%E7%9A%84%E3%81%A7%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82%20%E6%AC%A1%E3%81%AE%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E9%96%93%E3%81%AE%E3%83%94%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%81%A8%E3%81%97%E3%81%BE%E3%81%99%E3%80%82) ãŸã‚ã€éš£ã‚Šåˆã£ã¦ã„ãªã„ VNet ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ã¤ã„ã¦ã¯ã€
æ˜ç¤ºçš„ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€ä¸‹éƒ¨ã®é‹ç”¨ VNet ã¯æ§‹æˆã«å¿…é ˆã§ã¯ãªãã€å„ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã‚ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã®ä¿å®ˆã‚’è¡Œã†ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
ä»Šå›ã¯ã€ä»®æƒ³ãƒã‚·ãƒ³ VM-OPS ã‹ã‚‰ VM-01 ã«å…¥ã‚Šã€ç–é€šã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚

![å…¨ä½“ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆå›³](/images/8e4144734ec5b6/image.png)

# â‘  ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç–é€šã«ã¤ã„ã¦

ä»®æƒ³ãƒã‚·ãƒ³ ```VM-01``` ã‹ã‚‰ä»®æƒ³ãƒã‚·ãƒ³ ```VM-02``` ã«ã¤ã„ã¦ã®ç–é€šã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã¾ãšã€å½“åˆã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹æˆã‹ã‚‰ã€ãã‚Œãã‚ŒãŒæ‰€å±ã™ã‚‹ ã‚¹ãƒãƒ¼ã‚¯ VNet #1 ãŠã‚ˆã³ã‚¹ãƒãƒ¼ã‚¯ VNet #2 ã«ãŠã„ã¦ã€
ãƒãƒ– (Azure Firewall) ã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ«ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€åŒæ–¹ã® VNet ã‹ã‚‰é€šä¿¡ã¯ã€ãƒãƒ– VNet #1 ã® Azure Firewall ã‚’çµŒç”±ã—ã¾ã™ã€‚

![VM-01ã‹ã‚‰VM-02ã¸ã®ç–é€š](/images/8e4144734ec5b6/image-1.png)

ãŸã ã—ã€ä¸Šè¨˜ã«ã‚ã£ãŸã‚ˆã†ã«ã€æ¨ç§»çš„ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã€
ã‚¹ãƒãƒ¼ã‚¯ VNet #1 -> ãƒãƒ– VNet #1 -> ã‚¹ãƒãƒ¼ã‚¯ VNet #2 ã¨ã„ã†é€šä¿¡ã¯æˆã‚Šç«‹ã¡ã¾ã›ã‚“ã€‚
ãã“ã§ã€Azure Firewall ãƒ«ãƒ¼ãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ãã®ç–é€šãŒå¯èƒ½ã¨ãªã‚Šã¾ã™
(è¨±å¯ã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚„ãƒãƒ¼ãƒˆã¯è¦ä»¶ã«åˆã‚ã›ã¦è¦èª¿æ•´)ã€‚

|è¨­å®šé …ç›®|ãƒ«ãƒ¼ãƒ«1|ãƒ«ãƒ¼ãƒ«2|
|-------|-------|-------|
|è¦å‰‡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡|è¨±å¯|è¨±å¯|
|ã‚½ãƒ¼ã‚¹ã®ç¨®é¡|IP ã‚¢ãƒ‰ãƒ¬ã‚¹|IP ã‚¢ãƒ‰ãƒ¬ã‚¹|
|ã‚½ãƒ¼ã‚¹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹|10.1.0.0/16|10.2.0.0/16|
|å®›å…ˆã®ç¨®é¡|IP addresses|IP addresses|
|å®›å…ˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹|10.2.0.0/16|10.1.0.0/16|
|ãƒ—ãƒ­ãƒˆã‚³ãƒ«|ä»»æ„|ä»»æ„|
|ãƒãƒ¼ãƒˆ|*|*|

è¨­å®šå¾Œã€ç–é€šã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![VM-01ã‹ã‚‰VM-02ã¸ã®ç–é€šç¢ºèª](/images/8e4144734ec5b6/image-2.png)

# â‘¡ ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç–é€šã«ã¤ã„ã¦

æ¬¡ã«ã€ä»®æƒ³ãƒã‚·ãƒ³ ```VM-01``` ã‹ã‚‰ä»®æƒ³ãƒã‚·ãƒ³ ```VM-03``` ã«ã¤ã„ã¦ã®ç–é€šã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã† (ä»®æƒ³ãƒã‚·ãƒ³ ```VM-04``` ã‚‚åŒã˜è€ƒãˆæ–¹)ã€‚

![VM-01ã‹ã‚‰VM-03ã¸ã®ç–é€š](/images/8e4144734ec5b6/image-3.png)

å…ˆã®å ´åˆã¨åŒæ§˜ã«ã€Azure Firewall ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ«ãƒ¼ãƒ«ã«å¯¾ã—ã¦ã€
ã‚¹ãƒãƒ¼ã‚¯ VNet #3 ã®ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™)ã€‚

|è¨­å®šé …ç›®|ãƒ«ãƒ¼ãƒ«3|ãƒ«ãƒ¼ãƒ«4|
|-------|-------|-------|
|è¦å‰‡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡|è¨±å¯|è¨±å¯|
|ã‚½ãƒ¼ã‚¹ã®ç¨®é¡|IP ã‚¢ãƒ‰ãƒ¬ã‚¹|IP ã‚¢ãƒ‰ãƒ¬ã‚¹|
|ã‚½ãƒ¼ã‚¹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹|10.1.0.0/16,10.2.0.0/16|192.168.3.0/24,192.168.4.0/24|
|å®›å…ˆã®ç¨®é¡|IP addresses|IP addresses|
|å®›å…ˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹|192.168.3.0/24,192.168.4.0/24|10.1.0.0/16,10.2.0.0/16|
|ãƒ—ãƒ­ãƒˆã‚³ãƒ«|ä»»æ„|ä»»æ„|
|ãƒãƒ¼ãƒˆ|*|*|

ãŸã ã€ã“ã®ã¾ã¾ã§ã¯ Azure Firewall ã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ã®ç–é€šãŒè©¦è¡Œã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€
ã‚¹ãƒãƒ¼ã‚¯ VNet #3 ã¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ç®¡ç†ã™ã‚‹ãƒãƒ– VNet #2 ã® Azure Fireweall (azfw2) ã«æŒ¯ã‚Šå‘ã‘ãªãã¦ãªãªã‚Šã¾ã›ã‚“ã€‚

ãã®ãŸã‚ã€```azfw1``` ãŒã‚ã‚‹ AzureFirewallSubnet ã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ«ãƒ¼ãƒˆã‚’é–¢é€£ä»˜ã‘ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦ã€ã‚¹ãƒãƒ¼ã‚¯ VNet #3 ãŠã‚ˆã³ã‚¹ãƒãƒ¼ã‚¯ VNet #4 ã¸ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒ ```azfw2``` ã«æŒ¯ã‚Šå‘ã‘ã‚‰ã‚Œã¾ã™ã€‚

![HubVNET1ã®UDR](/images/8e4144734ec5b6/image-4.png)

ã¾ãŸã€æˆ»ã‚Šã®é€šä¿¡ã®ãŸã‚ã€```azfw2``` ã®ã‚ã‚‹ AzureFirewallSubnet ã«å¯¾ã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ«ãƒ¼ãƒˆãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚
ãã‚Œã¯ã“ã¡ã‚‰ã«ãªã‚Šã¾ã™ã€‚

![HubVNET2ã®UDR](/images/8e4144734ec5b6/image-5.png)

æœ€å¾Œã«ã€ ```azfw2``` ã® Azure Firewall ãƒ«ãƒ¼ãƒ«ã«å¯¾ã—ã¦ã€ã‚¹ãƒãƒ¼ã‚¯ VNet #1 ãŠã‚ˆã³ã‚¹ãƒãƒ¼ã‚¯ VNet #2 ã®ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚

|è¨­å®šé …ç›®|ãƒ«ãƒ¼ãƒ«5|ãƒ«ãƒ¼ãƒ«6|
|-------|-------|-------|
|è¦å‰‡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡|è¨±å¯|è¨±å¯|
|ã‚½ãƒ¼ã‚¹ã®ç¨®é¡|IP ã‚¢ãƒ‰ãƒ¬ã‚¹|IP ã‚¢ãƒ‰ãƒ¬ã‚¹|
|ã‚½ãƒ¼ã‚¹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹|10.1.0.0/16,10.2.0.0/16|192.168.3.0/24,192.168.4.0/24|
|å®›å…ˆã®ç¨®é¡|IP addresses|IP addresses|
|å®›å…ˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹|192.168.3.0/24,192.168.4.0/24|10.1.0.0/16,10.2.0.0/16|
|ãƒ—ãƒ­ãƒˆã‚³ãƒ«|ä»»æ„|ä»»æ„|
|ãƒãƒ¼ãƒˆ|*|*|

ã“ã‚Œã§ã€ã‚¹ãƒãƒ¼ã‚¯ VNet #1 ã‹ã‚‰ã‚¹ãƒãƒ¼ã‚¯ VNet #3 ã¸ã®ç–é€šãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

![VM-01ã‹ã‚‰VM-03ã¸ã®ç–é€šç¢ºèª](/images/8e4144734ec5b6/image-6.png)

:::message
ä»Šå›ã®æ§‹æˆã¯ã€Azure Firewall ã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ã®ç–é€šã¯ã€è¨±å¯ã—ã¦ã„ã¾ã›ã‚“ã€‚
å¿…è¦ãªå ´åˆã¯ã€Azure Firewall ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ«ãƒ¼ãƒ« ã‚‚ã—ãã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ«ãƒ¼ãƒ«ã‚’é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
:::

# ã¾ã¨ã‚

Hub & Spoke æ§‹æˆã«ãŠã„ã¦ã€Azure Firewall ã‚’ä½¿ã£ã¦ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã®ç–é€šã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æ–¹æ³•ã«ã¤ã„ã¦ç¢ºèªã—ã¾ã—ãŸã€‚
ã“ã‚Œä»¥å¤–ã«ã‚‚ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã®å¿…è¦ãªç–é€šãŒç‰¹å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°ã€ãã®ã‚¹ãƒãƒ¼ã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã§ VNet ãƒ”ã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã†æ–¹ãŒã€
Azure Firewall ã‚’çµŒç”±ã™ã‚‹ã‚ˆã‚Šã‚‚è¨­å®šã€æ€§èƒ½é¢ã€ã‚³ã‚¹ãƒˆé¢ã§ã‚‚æœ€å–„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã®ã§ã€ä½µã›ã¦æ¤œè¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# å‚è€ƒæƒ…å ±

* [Azure Firewall ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ«ãƒ ãƒãƒ– ã‚¢ãƒ³ãƒ‰ ã‚¹ãƒãƒ¼ã‚¯ ãƒˆãƒãƒ­ã‚¸ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹](https://learn.microsoft.com/ja-jp/azure/firewall/firewall-multi-hub-spoke)
* ç’°å¢ƒã‚’ä½œæˆã™ã‚‹ Bicep ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚µãƒ³ãƒ—ãƒ«

:::details ã‚µãƒ³ãƒ—ãƒ« Bicep ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```bicep
param location1 string = 'japaneast'
param location2 string = 'japanwest'

param hubVnetName1 string = 'hubvnet1'
param hubVnetName2 string = 'hubvnet2'

param spokeVnetName1 string = 'spokevnet1'
param spokeVnetName2 string = 'spokevnet2'
param spokeVnetName3 string = 'spokevnet3'
param spokeVnetName4 string = 'spokevnet4'

param azfirewallName1 string = 'azfw1'
param azfirewallName2 string = 'azfw2'

@secure()
param adminUserName string

@secure()
param adminPassword string

// Define the hub virtual network #1
resource hubvnet1 'Microsoft.Network/virtualNetworks@2022-05-01' = {
  name: hubVnetName1
  location: location1
  properties: {
    addressSpace: {
      addressPrefixes: [
        '10.0.0.0/16'
      ]
    }
    subnets: [
      {
        name: 'AzureFirewallSubnet'
        properties: {
          addressPrefix: '10.0.0.0/26'
        }
      }
    ]
  }
  tags: {
    displayName: 'hubvnet1'
  }
}

// Define the subnet for the Azure Firewall in the hub virtual network #1
resource hubSubnet1 'Microsoft.Network/virtualNetworks/subnets@2022-05-01' = {
  parent: hubvnet1
  name: 'AzureFirewallSubnet'
  properties: {
    addressPrefix: '10.0.0.0/26'
    routeTable: {
      id: hubRouteTable1.id
    }
  }
}

// Define the hub virtual network #2
resource hubvnet2 'Microsoft.Network/virtualNetworks@2022-05-01' = {
  name: hubVnetName2
  location: location2
  properties: {
    addressSpace: {
      addressPrefixes: [
        '192.168.0.0/24'
      ]
    }
    subnets: [
      {
        name: 'AzureFirewallSubnet'
        properties: {
          addressPrefix: '192.168.0.0/26'
        }
      }
    ]
  }
  tags: {
    displayName: 'hubvnet2'
  }
}

// Define the subnet for the Azure Firewall in the hub virtual network #2
resource hubSubnet2 'Microsoft.Network/virtualNetworks/subnets@2022-05-01' = {
  parent: hubvnet2
  name: 'AzureFirewallSubnet'
  properties: {
    addressPrefix: '192.168.0.0/26'
    routeTable: {
      id: hubRouteTable2.id
    }
  }
}

// Define the spoke virtual network #1
resource spokevnet1 'Microsoft.Network/virtualNetworks@2022-05-01' = {
  name: spokeVnetName1
  location: location1
  properties: {
    addressSpace: {
      addressPrefixes: [
        '10.1.0.0/16'
      ]
    }
    subnets: [
      {
        name: 'default'
        properties: {
          addressPrefix: '10.1.0.0/24'
          routeTable: {
            id: spokeRouteTable1.id
          }
        }
      }
    ]
  }
  tags: {
    displayName: 'spokevnet1'
  }
}

// Define the spoke virtual network #2
resource spokevnet2 'Microsoft.Network/virtualNetworks@2022-05-01' = {
  name: spokeVnetName2
  location: location1
  properties: {
    addressSpace: {
      addressPrefixes: [
        '10.2.0.0/16'
      ]
    }
    subnets: [
      {
        name: 'default'
        properties: {
          addressPrefix: '10.2.0.0/24'
          routeTable: {
            id: spokeRouteTable1.id
          }
        }
      }
    ]
  }
  tags: {
    displayName: 'spokevnet2'
  }
}

// Define the spoke virtual network #3
resource spokevnet3 'Microsoft.Network/virtualNetworks@2022-05-01' = {
  name: spokeVnetName3
  location: location2
  properties: {
    addressSpace: {
      addressPrefixes: [
        '192.168.3.0/24'
      ]
    }
    subnets: [
      {
        name: 'default'
        properties: {
          addressPrefix: '192.168.3.0/24'
          routeTable: {
            id: spokeRouteTable2.id
          }
        }
      }
    ]
  }
  tags: {
    displayName: 'spokevnet3'
  }
}

// Define the spoke virtual network #4
resource spokevnet4 'Microsoft.Network/virtualNetworks@2022-05-01' = {
  name: spokeVnetName4
  location: location2
  properties: {
    addressSpace: {
      addressPrefixes: [
        '192.168.4.0/24'
      ]
    }
    subnets: [
      {
        name: 'default'
        properties: {
          addressPrefix: '192.168.4.0/24'
          routeTable: {
            id: spokeRouteTable2.id
          }
        }
      }
    ]
  }
  tags: {
    displayName: 'spokevnet4'
  }
}

// Define the OPS virtual network
resource opsvnet 'Microsoft.Network/virtualNetworks@2022-05-01' = {
  name: 'opsvnet'
  location: location1
  properties: {
    addressSpace: {
      addressPrefixes: [
        '172.1.0.0/24'
      ]
    }
    subnets: [
      {
        name: 'default'
        properties: {
          addressPrefix: '172.1.0.0/24'
        }
      }
    ]
  }
  tags: {
    displayName: 'opsvnet'
  }
}

// Define the hub-to-spoke virtual network peering #1
resource hubToSpoke1 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: hubvnet1
  name: 'hubToSpoke1'
  properties: {
    remoteVirtualNetwork: {
      id: spokevnet1.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the spoke virtual network #1-to-hub virtual network peering
resource spokeToHub1 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: spokevnet1
  name: 'spokeToHub1'
  properties: {
    remoteVirtualNetwork: {
      id: hubvnet1.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the hub-to-spoke virtual network peering #2
resource hubToSpoke2 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: hubvnet1
  name: 'hubToSpoke2'
  properties: {
    remoteVirtualNetwork: {
      id: spokevnet2.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the spoke virtual network #2-to-hub virtual network peering
resource spokeToHub2 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: spokevnet2
  name: 'spokeToHub2'
  properties: {
    remoteVirtualNetwork: {
      id: hubvnet1.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the hub-to-spoke virtual network peering #3
resource hubToSpoke3 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: hubvnet2
  name: 'hubToSpoke3'
  properties: {
    remoteVirtualNetwork: {
      id: spokevnet3.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the spoke virtual network #3-to-hub virtual network peering
resource spokeToHub3 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: spokevnet3
  name: 'spokeToHub3'
  properties: {
    remoteVirtualNetwork: {
      id: hubvnet2.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the hub-to-spoke virtual network peering #4
resource hubToSpoke4 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: hubvnet2
  name: 'hubToSpoke4'
  properties: {
    remoteVirtualNetwork: {
      id: spokevnet4.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the spoke virtual network #4-to-hub virtual network peering
resource spokeToHub4 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: spokevnet4
  name: 'spokeToHub4'
  properties: {
    remoteVirtualNetwork: {
      id: hubvnet2.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the hub-to-hub virtual network peering1
resource hubToHub1 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: hubvnet1
  name: 'hubToHub1'
  properties: {
    remoteVirtualNetwork: {
      id: hubvnet2.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the hub-to-hub virtual network peering2
resource hubToHub2 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: hubvnet2
  name: 'hubToHub2'
  properties: {
    remoteVirtualNetwork: {
      id: hubvnet1.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the ops-to-spoke virtual network peering #1
resource opsToSpoke1 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: opsvnet
  name: 'opsToSpoke1'
  properties: {
    remoteVirtualNetwork: {
      id: spokevnet1.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the spoke virtual network #1-to-ops virtual network peering
resource spokeToOps1 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: spokevnet1
  name: 'spokeToOps1'
  properties: {
    remoteVirtualNetwork: {
      id: opsvnet.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the ops-to-spoke virtual network peering #2
resource opsToSpoke2 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: opsvnet
  name: 'opsToSpoke2'
  properties: {
    remoteVirtualNetwork: {
      id: spokevnet2.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Deifne the spoke virtual network #2-to-ops virtual network peering
resource spokeToOps2 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: spokevnet2
  name: 'spokeToOps2'
  properties: {
    remoteVirtualNetwork: {
      id: opsvnet.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the ops-to-spoke virtual network peering #3
resource opsToSpoke3 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: opsvnet
  name: 'opsToSpoke3'
  properties: {
    remoteVirtualNetwork: {
      id: spokevnet3.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the spoke virtual network #3-to-ops virtual network peering
resource spokeToOps3 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: spokevnet3
  name: 'spokeToOps3'
  properties: {
    remoteVirtualNetwork: {
      id: opsvnet.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the ops-to-spoke virtual network peering #4
resource opsToSpoke4 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: opsvnet
  name: 'opsToSpoke4'
  properties: {
    remoteVirtualNetwork: {
      id: spokevnet4.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the spoke virtual network #4-to-ops virtual network peering
resource spokeToOps4 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2022-05-01' = {
  parent: spokevnet4
  name: 'spokeToOps4'
  properties: {
    remoteVirtualNetwork: {
      id: opsvnet.id
    }
    allowVirtualNetworkAccess: true
    allowForwardedTraffic: true
    allowGatewayTransit: false
    useRemoteGateways: false
  }
}

// Define the public IP address for the Azure Firewall in the hub virtual network #1
resource azurePublicIp1 'Microsoft.Network/publicIPAddresses@2022-05-01' = {
  name: 'azfwPublicIp1'
  location: location1
  sku: {
    name: 'Standard'
  }
  properties: {
    publicIPAllocationMethod: 'Static'
  }
  tags: {
    displayName: 'azfwPublicIp1'
  }
}

// Define the Azure Firewall in the hub virtual network #1
resource azureFirewall1 'Microsoft.Network/azureFirewalls@2022-05-01' = {
  name: azfirewallName1
  location: location1
  properties: {
    ipConfigurations: [
      {
        name: 'azureFirewallIpConfiguration'
        properties: {
          subnet: {
            id: '${hubvnet1.id}/subnets/AzureFirewallSubnet'
          }
          publicIPAddress: {
            id: azurePublicIp1.id
          }
        }
      }
    ]
    networkRuleCollections: [
      {
        name: 'hubspoketransition'
        properties: {
          action: {
            type: 'Allow'
          }
          priority: 100
          rules: [
            {
              name: 'towest'
              description: 'Allow outgoing traffic from Japan East.'
              sourceAddresses: [
                '10.1.0.0/16'
                '10.2.0.0/16'
              ]
              destinationAddresses: [
                '192.168.3.0/24'
                '192.168.4.0/24'
              ]
              destinationPorts: [
                '*'
              ]
              protocols: [
                'Any'
              ]
            }
            {
              name: 'fromwest'
              description: 'Allow incoming traffic from Japan West.'
              sourceAddresses: [
                '192.168.3.0/24'
                '192.168.4.0/24'
              ]
              destinationAddresses: [
                '10.1.0.0/16'
                '10.2.0.0/16'
              ]
              destinationPorts: [
                '*'
              ]
              protocols: [
                'Any'
              ]
            }
            {
              name: 'spoketospoke1'
              description: 'Allow inter-spoke communication.'
              sourceAddresses: [
                '10.1.0.0/16'
              ]
              destinationAddresses: [
                '10.2.0.0/16'
              ]
              destinationPorts: [
                '*'
              ]
              protocols: [
                'Any'
              ]
            }
            {
              name: 'spoketospoke2'
              description: 'Allow inter-spoke communication.'
              sourceAddresses: [
                '10.2.0.0/16'
              ]
              destinationAddresses: [
                '10.1.0.0/16'
              ]
              destinationPorts: [
                '*'
              ]
              protocols: [
                'Any'
              ]
            }
          ]
        }
      }
    ]
  }
}

// Deifne the public IP address for the Azure Firewall in the hub virtual network #2
resource azurePublicIp2 'Microsoft.Network/publicIPAddresses@2022-05-01' = {
  name: 'azfwPublicIp2'
  location: location2
  sku: {
    name: 'Standard'
  }
  properties: {
    publicIPAllocationMethod: 'Static'
  }
  tags: {
    displayName: 'azfwPublicIp2'
  }
}

// Define the Azure Firewall in the hub virtual network #2
resource azureFirewall2 'Microsoft.Network/azureFirewalls@2022-05-01' = {
  name: azfirewallName2
  location: location2
  properties: {
    ipConfigurations: [
      {
        name: 'azureFirewallIpConfiguration'
        properties: {
          subnet: {
            id: '${hubvnet2.id}/subnets/AzureFirewallSubnet'
          }
          publicIPAddress: {
            id: azurePublicIp2.id
          }
        }
      }
    ]
    networkRuleCollections: [
      {
        name: 'hubspoketransition'
        properties: {
          action: {
            type: 'Allow'
          }
          priority: 100
          rules: [
            {
              name: 'toeast'
              description: 'Allow incoming traffic from Japan West.'
              sourceAddresses: [
                '192.168.3.0/24'
                '192.168.4.0/24'
              ]
              destinationAddresses: [
                '10.1.0.0/16'
                '10.2.0.0/16'
              ]
              destinationPorts: [
                '*'
              ]
              protocols: [
                'Any'
              ]
            }
            {
              name: 'fromeast'
              description: 'Allow outgoing traffic from Japan East.'
              sourceAddresses: [
                '10.1.0.0/16'
                '10.2.0.0/16'
              ]
              destinationAddresses: [
                '192.168.3.0/24'
                '192.168.4.0/24'
              ]
              destinationPorts: [
                '*'
              ]
              protocols: [
                'Any'
              ]
            }
            {
              name: 'spoketospoke1'
              description: 'Allow inter-spoke communication.'
              sourceAddresses: [
                '192.168.3.0/24'
              ]
              destinationAddresses: [
                '192.168.4.0/24'
              ]
              destinationPorts: [
                '*'
              ]
              protocols: [
                'Any'
              ]
            }
            {
              name: 'spoketospoke2'
              description: 'Allow inter-spoke communication.'
              sourceAddresses: [
                '192.168.4.0/24'
              ]
              destinationAddresses: [
                '192.168.3.0/24'
              ]
              destinationPorts: [
                '*'
              ]
              protocols: [
                'Any'
              ]
            }
          ]
        }
      }
    ]
  }
}


// Define the route table for the hub virtual network #1
resource hubRouteTable1 'Microsoft.Network/routeTables@2022-05-01' = {
  name: 'hubRouteTable1'
  location: location1
  properties: {
    disableBgpRoutePropagation: false
    routes: [
      {
        name: 'hubToInternet'
        properties: {
          addressPrefix: '0.0.0.0/0'
          nextHopType: 'Internet'
        }
      }
      {
        name: 'toSpokeVnet3'
        properties: {
          addressPrefix: '192.168.3.0/24'
          nextHopType: 'VirtualAppliance'
          nextHopIpAddress: azureFirewall2.properties.ipConfigurations[0].properties.privateIPAddress
          
        }
      }
      {
        name: 'toSpokeVnet4'
        properties: {
          addressPrefix: '192.168.4.0/24'
          nextHopType: 'VirtualAppliance'
          nextHopIpAddress: azureFirewall2.properties.ipConfigurations[0].properties.privateIPAddress
        }
      }
    ]
  }
  tags: {
    displayName: 'hubRouteTable1'
  }
}

// Define the route table for the hub virtual network #2
resource hubRouteTable2 'Microsoft.Network/routeTables@2022-05-01' = {
  name: 'hubRouteTable2'
  location: location2
  properties: {
    disableBgpRoutePropagation: false
    routes: [
      {
        name: 'hubTointernet'
        properties: {
          addressPrefix: '0.0.0.0/0'
          nextHopType: 'Internet'
        }
      }
      {
        name: 'toSpokeVnet1'
        properties: {
          addressPrefix: '10.1.0.0/24'
          nextHopType: 'VirtualAppliance'
          nextHopIpAddress: azureFirewall1.properties.ipConfigurations[0].properties.privateIPAddress
        }
      }
      {
        name: 'toSpokeVnet2'
        properties: {
          addressPrefix: '10.2.0.0/24'
          nextHopType: 'VirtualAppliance'
          nextHopIpAddress: azureFirewall1.properties.ipConfigurations[0].properties.privateIPAddress
        }
      }
    ]
  }
  tags: {
    displayName: 'hubRouteTable2'
  }
}

// Define the route table toward Azure Fireweall #1
resource spokeRouteTable1 'Microsoft.Network/routeTables@2022-05-01' = {
  name: 'spokeRouteTable1'
  location: location1
  properties: {
    disableBgpRoutePropagation: false
    routes: [
      {
        name: 'toHubVnet1'
        properties: {
          addressPrefix: '0.0.0.0/0'
          nextHopType: 'VirtualAppliance'
          nextHopIpAddress: azureFirewall1.properties.ipConfigurations[0].properties.privateIPAddress
        }
      }
    ]
  }
  tags: {
    displayName: 'spokeRouteTable1'
  }
}

// Define the routae table toward Azure Firewall #2
resource spokeRouteTable2 'Microsoft.Network/routeTables@2022-05-01' = {
  name: 'spokeRouteTable2'
  location: location2
  properties: {
    disableBgpRoutePropagation: false
    routes: [
      {
        name: 'toHubVnet2'
        properties: {
          addressPrefix: '0.0.0.0/0'
          nextHopType: 'VirtualAppliance'
          nextHopIpAddress: azureFirewall2.properties.ipConfigurations[0].properties.privateIPAddress
        }
      }
    ]
  }
  tags: {
    displayName: 'spokeRouteTable2'
  }
}

// Define the NIC for vm01
resource vmnic01 'Microsoft.Network/networkInterfaces@2022-09-01' = {
  name: 'vmnic01'
  location: location1
  properties: {
    ipConfigurations: [
      {
        name: 'ipconfig1'
        properties: {
          subnet: {
            id: spokevnet1.properties.subnets[0].id
          }
          privateIPAllocationMethod: 'Dynamic'
        }
      }
    ]
  }
  tags: {
    displayName: 'vmnic01'
  }
}

// Define the NIC for vm02
resource vmnic02 'Microsoft.Network/networkInterfaces@2022-09-01' = {
  name: 'vmnic02'
  location: location1
  properties: {
    ipConfigurations: [
      {
        name: 'ipconfig1'
        properties: {
          subnet: {
            id: spokevnet2.properties.subnets[0].id
          }
          privateIPAllocationMethod: 'Dynamic'
        }
      }
    ]
  }
  tags: {
    displayName: 'vmnic02'
  }
}

// Define the NIC for vm03
resource vmnic03 'Microsoft.Network/networkInterfaces@2022-09-01' = {
  name: 'vmnic03'
  location: location2
  properties: {
    ipConfigurations: [
      {
        name: 'ipconfig1'
        properties: {
          subnet: {
            id: spokevnet3.properties.subnets[0].id
          }
          privateIPAllocationMethod: 'Dynamic'
        }
      }
    ]
  }
  tags: {
    displayName: 'vmnic03'
  }
}

// Define the NIC for opvm
resource opvmnic 'Microsoft.Network/networkInterfaces@2022-09-01' = {
  name: 'opvmnic'
  location: location1
  properties: {
    ipConfigurations: [
      {
        name: 'ipconfig1'
        properties: {
          subnet: {
            id: opsvnet.properties.subnets[0].id
          }
          privateIPAllocationMethod: 'Dynamic'
        }
      }
    ]
  }
  tags: {
    displayName: 'vmnic04'
  }
}

// Define vm01
resource vm01 'Microsoft.Compute/virtualMachines@2022-03-01' = {
  name: 'vm01'
  location: location1
  properties: {
    hardwareProfile: {
      vmSize: 'Standard_D2as_v4'
    }
    osProfile: {
      computerName: 'vm01'
      adminUsername: adminUserName
      adminPassword: adminPassword
    }
    storageProfile: {
      imageReference: {
        publisher: 'Canonical'
        offer: '0001-com-ubuntu-confidential-vm-jammy'
        sku: '22_04-lts-cvm'
        version: 'latest'
      }
      osDisk: {
        name: 'osdisk01'
        caching: 'ReadWrite'
        createOption: 'FromImage'
      }
    }
    networkProfile: {
      networkInterfaces: [
        {
          id: vmnic01.id
        }
      ]
    }
  }
}

// Define vm02
resource vm02 'Microsoft.Compute/virtualMachines@2022-03-01' = {
  name: 'vm02'
  location: location1
  properties: {
    hardwareProfile: {
      vmSize: 'Standard_D2as_v4'
    }
    osProfile: {
      computerName: 'vm02'
      adminUsername: adminUserName
      adminPassword: adminPassword
    }
    storageProfile: {
      imageReference: {
        publisher: 'Canonical'
        offer: '0001-com-ubuntu-confidential-vm-jammy'
        sku: '22_04-lts-cvm'
        version: 'latest'
      }
      osDisk: {
        name: 'osdisk02'
        caching: 'ReadWrite'
        createOption: 'FromImage'
      }
    }
    networkProfile: {
      networkInterfaces: [
        {
          id: vmnic02.id
        }
      ]
    }
  }
}

// Define vm03
resource vm03 'Microsoft.Compute/virtualMachines@2022-03-01' = {
  name: 'vm03'
  location: location2
  properties: {
    hardwareProfile: {
      vmSize: 'Standard_D2as_v4'
    }
    osProfile: {
      computerName: 'vm03'
      adminUsername: adminUserName
      adminPassword: adminPassword
    }
    storageProfile: {
      imageReference: {
        publisher: 'Canonical'
        offer: '0001-com-ubuntu-confidential-vm-jammy'
        sku: '22_04-lts-cvm'
        version: 'latest'
      }
      osDisk: {
        name: 'osdisk03'
        caching: 'ReadWrite'
        createOption: 'FromImage'
      }
    }
    networkProfile: {
      networkInterfaces: [
        {
          id: vmnic03.id
        }
      ]
    }
  }
}

// Define opsvm
resource opsvm 'Microsoft.Compute/virtualMachines@2022-03-01' = {
  name: 'opsvm'
  location: location1
  properties: {
    hardwareProfile: {
      vmSize: 'Standard_D2as_v4'
    }
    osProfile: {
      computerName: 'opsvm'
      adminUsername: adminUserName
      adminPassword: adminPassword
    }
    storageProfile: {
      imageReference: {
        publisher: 'Canonical'
        offer: '0001-com-ubuntu-confidential-vm-jammy'
        sku: '22_04-lts-cvm'
        version: 'latest'
      }
      osDisk: {
        name: 'osdisk04'
        caching: 'ReadWrite'
        createOption: 'FromImage'
      }
    }
    networkProfile: {
      networkInterfaces: [
        {
          id: opvmnic.id
        }
      ]
    }
  }
}
```
:::