---
title: "å…¥ã‚Œå­ã«ãªã£ãŸä»®æƒ³ãƒã‚·ãƒ³ã®æ§‹ç¯‰"
emoji: "ğŸ“¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

å…¥ã‚Œå­ã«ãªã£ãŸä»®æƒ³ãƒã‚·ãƒ³ã‚’æ‰‹æ—©ãç”¨æ„ã—ãŸã„å ´é¢ãŒã‚ã£ãŸã®ã§ã€ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

### å…¥ã‚Œå­ã«ãªã£ãŸä»®æƒ³ãƒã‚·ãƒ³ã¨ã¯

å…¥ã‚Œå­ã«ãªã£ãŸä»®æƒ³ãƒã‚·ãƒ³ã¨ã¯ã€ä»®æƒ³ãƒã‚·ãƒ³ã®ä¸­ã§ä»®æƒ³ãƒã‚·ãƒ³ã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã€
ãƒã‚¤ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸä»®æƒ³ãƒã‚·ãƒ³ã‚’æŒ‡ã—ã¾ã™ã€‚

å‚è€ƒ; [å…¥ã‚Œå­ã«ãªã£ãŸä»®æƒ³åŒ–ã®æ¦‚è¦](https://learn.microsoft.com/ja-jp/virtualization/hyper-v-on-windows/user-guide/nested-virtualization)

ãªãŠã€å…¥ã‚Œå­ã«ãªã£ãŸä»®æƒ³ãƒã‚·ãƒ³ã«ã¤ã„ã¦ã¯ã€ãƒ†ã‚¹ãƒˆã‚„è©•ä¾¡ç›®çš„ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

å‚è€ƒ; [Hyper-V VM ä¸Šã® Hyper-V VM](https://learn.microsoft.com/ja-jp/virtualization/hyper-v-on-windows/user-guide/nested-virtualization#hyper-v-vms-on-hyper-v-vms)

### æ–¹æ³•1 az vm repair create ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹

æ‰‹è»½ã«ä½œã‚‹æ–¹æ³•ã¨ã—ã¦ã¯ã€ä»®æƒ³ãƒã‚·ãƒ³ã®å¾©æ—§ã‚’ç›®çš„ã¨ã—ãŸ Azure CLI ã®ã‚³ãƒãƒ³ãƒ‰ [az vm repair](https://learn.microsoft.com/ja-jp/cli/azure/vm/repair?view=azure-cli-latest) ã‚’ä½¿ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€ä»®æƒ³ãƒã‚·ãƒ³ãŒä½•ã‚‰ã‹ã®è¦å› ã§èµ·å‹•ã—ãªããªã£ãŸã‚·ãƒŠãƒªã‚ªã«ãŠã„ã¦ã€å¾©æ—§ç”¨ã®ä»®æƒ³ãƒã‚·ãƒ³ã«å¯¾è±¡ä»®æƒ³ãƒã‚·ãƒ³ã® OS ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚¢ã‚¿ãƒƒãƒã—å¾©æ—§ä½œæ¥­ã‚’è¡Œã† (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¾©æ—§) ã‚’ç°¡ç´ åŒ–ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

æ—¢ã« Azure CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã—ãŸã‚‰ã€
ä»¥ä¸‹ã«ã¦ã€€```vm-repair``` æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```bash
$ az extension add -n vm-repair
```

ãã‚Œã§ã¯ã€ãƒ†ã‚¹ãƒˆç”¨ã®ä»®æƒ³ãƒã‚·ãƒ³ã‚’ä½œã‚Šã¾ã™ã€‚

```bash
$ az group create -n labnestedvm -l japaneast
$ az vm create -g labnestedvm --name nestedvm --image Win2022Datacenter --admin-username azureuser --public-ip-address ""
```

:::message alert
"vm-repair" ãŒ "1.0.0b1" ã®å ´åˆã€[Hyper-V is not installed in reapirVM #7177](https://github.com/Azure/azure-cli-extensions/issues/7177) ã§å ±å‘Šã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€Hyper-V ãŒæœ‰åŠ¹åŒ–ã•ã‚Œãªã„å•é¡ŒãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã¡ã‚‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã—ãŸã‚‰ã€ä¸Šè¨˜ issue ã«ã‚ã‚‹ "Backup existing script" ãŠã‚ˆã³ "Revert back" ã®æ‰‹é †ã«ã¦å›é¿å¯èƒ½ã§ã™ã€‚

vm-repair ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªæ–¹æ³•

```bash
$ az version
{
  "azure-cli": "2.56.0",
  "azure-cli-core": "2.56.0",
  "azure-cli-telemetry": "1.1.0",
  "extensions": {
    "ai-examples": "0.2.5",
    "ml": "2.22.0",
    "ssh": "2.0.2",
    "vm-repair": "1.0.0b1"
  }
}
```

:::

ãã®å¾Œã€å¾©æ—§ç”¨ã®ä»®æƒ³ãƒã‚·ãƒ³ã‚’ä½œã‚Šã¾ã™ã€‚ãã®éš›ã€```--enable-nested``` ã‚’æŒ‡å®šã™ã‚‹ã¨ã€
å¾©æ—§ç”¨ã®ä»®æƒ³ãƒã‚·ãƒ³ã« Hyper-V ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã€ãƒ†ã‚¹ãƒˆç”¨ã®ä»®æƒ³ãƒã‚·ãƒ³ãŒãã®ä»®æƒ³ãƒã‚·ãƒ³ã® Hyper-V ä¸Šã§ç¨¼åƒã™ã‚‹ã‚ˆã†ã«ã§ãã¾ã™ã€‚

```bash
$ az vm repair create -g labnestedvm -n nestedvm --repair-username azureuser --repair-password '<yourpassword>' --enable-nested --verbose
Does repair vm requires public ip? (y/n): y
Fetching architecture type of the source VM...
Fetching compatible Windows OS images from gallery...
Fetching available VM sizes for repair VM...
VM size 'Standard_D2s_v3' is available. Using it to create repair VM.

Checking for existing resource groups with identical name within subscription...
Pre-existing repair resource group with the same name is 'False'
Creating resource group for repair VM and its resources...
Source VM uses managed disks. Creating repair VM with managed disks.

Copying OS disk of source VM...
Creating repair VM with command: az vm create -g repair-nestedvm-20240122085949 -n repair-nestedv_ --tag repair_source=labnestedvm/nestedvm --image MicrosoftWindowsServer:WindowsServer:2016-Datacenter:2016.127.20190416 --admin-username azureuser --admin-password <yourpassword> --public-ip-address repair-nestedv_PublicIP --size Standard_D2s_v3
copy_disk_id: /subscriptions/<yoursubscription>/resourceGroups/labnestedvm/providers/Microsoft.Compute/disks/nestedvm-DiskCopy-20240122085949
repair_password: <yourpassword>
repair_username: azureuser
fix_uuid: False
Validating VM template before continuing...
Creating repair VM...
Running Script win-enable-nested-hyperv.ps1 to install HyperV
Restarting Repair VM
Running win-enable-nested-hyperv.ps1 again to create nested VM

Your repair VM 'repair-nestedv_' has been created in the resource group 'repair-nestedvm-20240122085949' with disk 'nestedvm-DiskCopy-20240122085949' attached as data disk. Please use this VM to troubleshoot and repair. Once the repairs are complete use the command 'az vm repair restore -n nestedvm -g labnestedvm --verbose' to restore disk to the source VM. Note that the copied disk is created within the original resource group 'labnestedvm'.

{
  "copied_disk_name": "nestedvm-DiskCopy-20240122085949",
  "copied_disk_uri": "/subscriptions/<yoursubscription>/resourceGroups/labnestedvm/providers/Microsoft.Compute/disks/nestedvm-DiskCopy-20240122085949",
  "created_resources": [
    "/subscriptions/<yoursubscription>/resourceGroups/repair-nestedvm-20240122085949/providers/Microsoft.Compute/virtualMachines/repair-nestedv_/extensions/MicrosoftMonitoringAgent",
    "/subscriptions/<yoursubscription>/resourceGroups/repair-nestedvm-20240122085949/providers/Microsoft.Network/networkInterfaces/repair-nestedv_VMNic",
    "/subscriptions/<yoursubscription>/resourceGroups/repair-nestedvm-20240122085949/providers/Microsoft.Compute/virtualMachines/repair-nestedv_/extensions/AzurePolicyforWindows",
    "/subscriptions/<yoursubscription>/resourceGroups/REPAIR-NESTEDVM-20240122085949/providers/Microsoft.Compute/disks/repair-nestedv__OsDisk_1_d08e2a3c2a6d4e6f887789de6e5bb989",
    "/subscriptions/<yoursubscription>/resourceGroups/repair-nestedvm-20240122085949/providers/Microsoft.Network/publicIPAddresses/repair-nestedv_PublicIP",
    "/subscriptions/<yoursubscription>/resourceGroups/repair-nestedvm-20240122085949/providers/Microsoft.Network/networkSecurityGroups/repair-nestedv_NSG",
    "/subscriptions/<yoursubscription>/resourceGroups/repair-nestedvm-20240122085949/providers/Microsoft.Network/virtualNetworks/repair-nestedv_VNET",
    "/subscriptions/<yoursubscription>/resourceGroups/repair-nestedvm-20240122085949/providers/Microsoft.Compute/virtualMachines/repair-nestedv_",
    "/subscriptions/<yoursubscription>/resourceGroups/labnestedvm/providers/Microsoft.Compute/disks/nestedvm-DiskCopy-20240122085949"
  ],
  "message": "Your repair VM 'repair-nestedv_' has been created in the resource group 'repair-nestedvm-20240122085949' with disk 'nestedvm-DiskCopy-20240122085949' attached as data disk. Please use this VM to troubleshoot and repair. Once the repairs are complete use the command 'az vm repair restore -n nestedvm -g labnestedvm --verbose' to restore disk to the source VM. Note that the copied disk is created within the original resource group 'labnestedvm'.",
  "repair_resource_group": "repair-nestedvm-20240122085949",
  "repair_vm_name": "repair-nestedv_",
  "resource_tag": "repair_source=labnestedvm/nestedvm",
  "status": "SUCCESS"
}
Command ran in 821.173 seconds (init: 0.088, invoke: 821.085)
yurio [ ~ ]$ 
```

![Alt text](image.png)

å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å†…å®¹ã¨ã—ã¦ã¯ã€"az vm repair run" ã‚³ãƒãƒ³ãƒ‰ã‚’å†…éƒ¨ã§ï¼’å›å®Ÿè¡Œã•ã‚Œã¦ãŠã‚Šã€
é–“ã« Hyper-V ã®æœ‰åŠ¹åŒ–ã«ä¼´ã„å¾©æ—§ç”¨ã®ä»®æƒ³ãƒã‚·ãƒ³ã‚’å†èµ·å‹•ã•ã›ã¦ã„ã¾ã™ã€‚

https://github.com/Azure/azure-cli-extensions/blob/f311e026ee86c8978bab7c2caa883dad26bbb89c/src/vm-repair/azext_vm_repair/custom.py#L222-L238

"az vm repair run" ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ PowerShell ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ã“ã¡ã‚‰ã® ```win-enable-nested-hyperv.ps1``` ã§ã€
ï¼‘é€±ç›®ã¯ä¸‹è¨˜ã«ã‚ˆã‚Š Hyper-V æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

https://github.com/Azure/azure-cli-extensions/blob/f311e026ee86c8978bab7c2caa883dad26bbb89c/src/vm-repair/azext_vm_repair/scripts/win-enable-nested-hyperv.ps1#L118-L132

ï¼’å‘¨ç›®ã¯ã€NAT ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€DHCPã€DNS ã®è¨­å®šã‚’è¡Œã„ã€
ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ (å…ƒã®ä»®æƒ³ãƒã‚·ãƒ³ã® OS ãƒ‡ã‚£ã‚¹ã‚¯) ã‚’ç”¨ã„ã¦ä»®æƒ³ãƒã‚·ãƒ³ã‚’ä½œã£ã¦ã„ã¾ã™ã€‚

https://github.com/Azure/azure-cli-extensions/blob/f311e026ee86c8978bab7c2caa883dad26bbb89c/src/vm-repair/azext_vm_repair/scripts/win-enable-nested-hyperv.ps1#L28-L116

### Azure Quick Templates ã‚’åˆ©ç”¨

https://learn.microsoft.com/en-us/samples/azure/azure-quickstart-templates/nested-vms-in-virtual-network/