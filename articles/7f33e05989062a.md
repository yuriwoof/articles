---
title: "入れ子になった仮想マシンの構築"
emoji: "📦"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

入れ子になった仮想マシンを手早く用意したい場面があったので、まとめておきます。

### 入れ子になった仮想マシンとは

入れ子になった仮想マシンとは、仮想マシンの中で仮想マシンを動作させるため、
ハイパーバイザがインストールされた仮想マシンを指します。

参考; [入れ子になった仮想化の概要](https://learn.microsoft.com/ja-jp/virtualization/hyper-v-on-windows/user-guide/nested-virtualization)

### az vm repair create コマンドによる

```bash
$ az group create -n labnestedvm -l japaneast
$ az vm create -g labnestedvm --name nestedvm --image Win2022AzureEditionCore --admin-username azureuser --public-ip-address ""
```

```bash
$ az extension add -n vm-repair
$ az version
{
  "azure-cli": "2.56.0",
  "azure-cli-core": "2.56.0",
  "azure-cli-telemetry": "1.1.0",
  "extensions": {
    "ai-examples": "0.2.5",
    "ml": "2.22.0",
    "ssh": "2.0.2",
    "vm-repair": "1.0.0b1"
  }
}
ohno [ ~ ]$ az vm repair create -g labnestedvm -n nestedvm --repair-username azureuser --repair-password 'password!234' --enable-nested --verbose
Does repair vm requires public ip? (y/n): y
Fetching architecture type of the source VM...
Fetching compatible Windows OS images from gallery...
Fetching available VM sizes for repair VM...
VM size 'Standard_D2s_v3' is available. Using it to create repair VM.

Checking for existing resource groups with identical name within subscription...
Pre-existing repair resource group with the same name is 'False'
Creating resource group for repair VM and its resources...
Source VM uses managed disks. Creating repair VM with managed disks.

Copying OS disk of source VM...
Creating repair VM with command: az vm create -g repair-nestedvm-20240120052118 -n repair-nestedv_ --tag repair_source=labnestedvm/nestedvm --image MicrosoftWindowsServer:WindowsServer:2016-Datacenter:2016.127.20190416 --admin-username azureuser --admin-password password!234 --public-ip-address repair-nestedv_PublicIP --size Standard_D2s_v3
copy_disk_id: /subscriptions/<yoursubcription>/resourceGroups/labnestedvm/providers/Microsoft.Compute/disks/nestedvm-DiskCopy-20240120052118
repair_password: password!234
repair_username: azureuser
fix_uuid: False
Validating VM template before continuing...
Creating repair VM...
Running Script win-enable-nested-hyperv.ps1 to install HyperV
Restarting Repair VM
Running win-enable-nested-hyperv.ps1 again to create nested VM

Your repair VM 'repair-nestedv_' has been created in the resource group 'repair-nestedvm-20240120052118' with disk 'nestedvm-DiskCopy-20240120052118' attached as data disk. Please use this VM to troubleshoot and repair. Once the repairs are complete use the command 'az vm repair restore -n nestedvm -g labnestedvm --verbose' to restore disk to the source VM. Note that the copied disk is created within the original resource group 'labnestedvm'.

{
  "copied_disk_name": "nestedvm-DiskCopy-20240120052118",
  "copied_disk_uri": "/subscriptions/<yoursubcription>/resourceGroups/labnestedvm/providers/Microsoft.Compute/disks/nestedvm-DiskCopy-20240120052118",
  "created_resources": [
    "/subscriptions/<yoursubcription>/resourceGroups/REPAIR-NESTEDVM-20240120052118/providers/Microsoft.Compute/disks/repair-nestedv__OsDisk_1_a746b4f931694abeb114aad598233e3d",
    "/subscriptions/<yoursubcription>/resourceGroups/repair-nestedvm-20240120052118/providers/Microsoft.Compute/virtualMachines/repair-nestedv_",
    "/subscriptions/<yoursubcription>/resourceGroups/repair-nestedvm-20240120052118/providers/Microsoft.Network/networkInterfaces/repair-nestedv_VMNic",
    "/subscriptions/<yoursubcription>/resourceGroups/repair-nestedvm-20240120052118/providers/Microsoft.Network/networkSecurityGroups/repair-nestedv_NSG",
    "/subscriptions/<yoursubcription>/resourceGroups/repair-nestedvm-20240120052118/providers/Microsoft.Network/publicIPAddresses/repair-nestedv_PublicIP",
    "/subscriptions/<yoursubcription>/resourceGroups/repair-nestedvm-20240120052118/providers/Microsoft.Network/virtualNetworks/repair-nestedv_VNET",
    "/subscriptions/<yoursubcription>/resourceGroups/labnestedvm/providers/Microsoft.Compute/disks/nestedvm-DiskCopy-20240120052118"
  ],
  "message": "Your repair VM 'repair-nestedv_' has been created in the resource group 'repair-nestedvm-20240120052118' with disk 'nestedvm-DiskCopy-20240120052118' attached as data disk. Please use this VM to troubleshoot and repair. Once the repairs are complete use the command 'az vm repair restore -n nestedvm -g labnestedvm --verbose' to restore disk to the source VM. Note that the copied disk is created within the original resource group 'labnestedvm'.",
  "repair_resource_group": "repair-nestedvm-20240120052118",
  "repair_vm_name": "repair-nestedv_",
  "resource_tag": "repair_source=labnestedvm/nestedvm",
  "status": "SUCCESS"
}
Command ran in 1324.636 seconds (init: 0.247, invoke: 1324.389) 
```

![Alt text](image.png)

https://github.com/Azure/azure-cli-extensions/blob/f311e026ee86c8978bab7c2caa883dad26bbb89c/src/vm-repair/azext_vm_repair/custom.py#L218
https://github.com/Azure/azure-cli-extensions/blob/main/src/vm-repair/azext_vm_repair/scripts/win-enable-nested-hyperv.ps1