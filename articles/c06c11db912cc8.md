---
title: "KubecostでAKS上のワークロードのコスト管理"
emoji: "🐖"
type: "tech"
topics: ["Azure","AKS","FinOps","Cost Management","Kubecost","Opencost"]
published: true
---

この記事では、AKS（Azure Kubernetes Service）上で動くワークロードのコストを見える化・配賦する方法をざっくり紹介します。  

クラウドを運用するとき、セキュリティと並んで「コスト管理」もとても大事です。
規模が大きくなると共通基盤と各業務ワークロードに分けて管理することが多く、
これをサブスクリプション単位で分けることでコストの集計も容易になります。

ただし、Kubernetes の場合は様相が異なります。
AKS などのクラスター上では名前空間やラベル、ノードプールの分離により複数の業務が共存することが可能です。
AKS クラスターやノードが異なるケースでは、Azure Cost Management で集計が可能ですが、
名前空間や Pod ラベルになるとそれが行えません。

![alt text](/images/c06c11db912cc8/kubecost1.png)

# モチベーション

Azure では、クラウドのコスト管理機能として [Azure Cost Management](https://learn.microsoft.com/ja-jp/azure/cost-management-billing/costs/overview-cost-management) が提供されています。
これで、Azure Kubernetes Service (AKS) のコストを見てみましょう。

![alt text](/images/c06c11db912cc8/kubecost2.png)

見ると、AKS (クラスター名 akslab1) とそれに紐づくノードプール (仮想マシン スケールセット) のコストは分かりますが、
やはりそれ以上の分解能はありません。
そのため、この記事では Kubernetes において稼働するワークロードのコストをどのようにはじき出すかという点を見てみます。

# OpenCost / Kubecost

このトピックでよく出てくる名前は OpenCost と Kubecost です。
OpenCost は CNCF 管理の オープンソースソフトウェアで、Kubecost は OpenCost をベースに企業向け機能（アラートや予測、異常検出など）を足したもの、というイメージです。

[KubecostとOpenCostの比較](https://www.apptio.com/topics/kubernetes/cost-optimization/kubecost-vs-opencost/test)

Azure 側にも OpenCost ベースの[コスト分析アドオン](https://learn.microsoft.com/ja-jp/azure/aks/cost-analysis)がありますが、
契約種別で使えない場合があるため、本記事では Helm で Kubecost を入れて試してみます。

> "Kubernetes のコストを表示する" より抜粋
> Kubernetes のコスト ビューは、次のサブスクリプション契約の種類でのみ使用できます。  
> - Enterprise Agreement  
> - Microsoft 顧客契約  

# Kubecost の導入

まずは、Azure に AKS クラスターをデプロイしましょう。
既に AKS クラスターを展開済みの方もいるかと思うのでデプロイ手順は折りたたんでおきます。

::::details 環境構築手順
:::message

リソースグループを作成

```bash
$ az group create --name rg-akslab --location japaneast
```

AKS をデプロイ（例）

```bash
$ az aks create -g rg-akslab -n akslab1 --node-count 3 --ssh-key-value ~/.ssh/id_rsa.pub --attach-acr acrforakslab --node-vm-size Standard_D4ds_v4
```

サンプルアプリケーションを展開

```bash
$ sudo az aks install-cli
$ az aks get-credentials --resource-group rg-akslab --name akslab1 --overwrite-existing
$ kubectl create namespace app
$ kubectl apply -f https://raw.githubusercontent.com/Azure-Samples/aks-store-demo/refs/heads/main/aks-store-quickstart.yaml -n app
```

動作確認（Pod の STATUS が Running になることを確認）

```bash
$ kubectl get pods -n app
```

サービスの公開 IP を取得してブラウザで確認

```bash
$ kubectl get service store-front -n app -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
```

:::
::::

それでは、Kubecost を AKS クラスターにデプロイしてみましょう。
Helm チャートで提供されていますので、[[Helm のインストール]](https://helm.sh/docs/intro/install/)がまだでしたら、
インストールしておきます。

Helm チャートを使って Kubecost を入れます。Helm が無ければ先にインストールしてください。

```bash
$ helm install kubecost cost-analyzer --repo https://kubecost.github.io/cost-analyzer/ --namespace kubecost --create-namespace
```

Pod が Ready になったら UI をローカルで見るために port‑forward します（例: http://localhost:9090）。

```bash
$ kubectl port-forward --namespace kubecost deployment/kubecost-cost-analyzer 9090
```

Pod が "Ready" になっているか確認します。
Kubecost は Prometheus からメトリックスを得てコスト分割を行っています。ビルトインで Prometheus と Grafana が展開されますが、
[既存の Prometheus を利用することも可能](https://www.ibm.com/docs/en/kubecost/self-hosted/2.x?topic=configuration-prometheus-guide)です。

```bash
$ kubectl get pods -n kubecost
NAME                                          READY   STATUS    RESTARTS   AGE
kubecost-cost-analyzer-5d679c857b-xjhg6       4/4     Running   0          2d4h
kubecost-forecasting-8cd68f7c5-6pm68          1/1     Running   0          2d4h
kubecost-grafana-5688b4fdb5-fbwft             2/2     Running   0          2d4h
kubecost-prometheus-server-6565bdcff4-xn57l   1/1     Running   0          2d4h
```

それでは Kubecost の Web インターフェースにアクセスします。
[公開することも可能](https://learn.microsoft.com/en-us/community/content/how-to-utilize-kubecost-for-cost-management-of-aks) ですが、ここでは ```kubectl port-foward``` にてローカルの Web ブラウザで ```http://localhost:9090``` を開きます。

```bash
$ kubectl port-forward --namespace kubecost deployment/kubecost-cost-analyzer 9090
```

![alt text](/images/c06c11db912cc8/kubecost3.png)

コスト割り当ての画面はこちら。
既定では名前空間 (Namespace) 毎に分類されています。

![alt text](kubecost4.png)

グルーピングの条件を例えばラベル毎に変更することも可能です。

![alt text](/images/c06c11db912cc8/kubecost5.png)

アセット (Assets) では Kubernetes クラスターを構成するコンポーネント (仮想マシンスケールセット、ロードバランサーなど) 毎のコストの内訳が確認できます。

![alt text](/images/c06c11db912cc8/kubecost6.png)

価格はどうやって取得しているのかというと、Azure の[小売り価格 API](https://learn.microsoft.com/ja-jp/rest/api/cost-management/retail-prices/azure-retail-prices) から取得していることが分かります。

```bash
$ kubectl logs kubecost-cost-analyzer-5d679c857b-n5xcz -n kubecost -f
...
27japaneast%27+and+armSkuName+eq+%27standard_d4ds_v4%27"
2025-08-22T08:43:20.269192099Z INF starting download retail price payload from "https://prices.azure.com/api/retail/prices?$skip=0&currencyCode='USD'&$filter=armRegionName+eq+%27japaneast%27+and+armSkuName+eq+%27standard_d4ds_v4%27"
```

さらに、節約 (Savings) のタブでは、各節約観点において月額辺りの節約予想額が見られます。
今のところ、AKS クラスターの機能サポートはありませんが、節約の推奨に従い、
クラスターのサイジングや、名前空間のターンダウンの自動化が Actions から設定可能です。

![alt text](/images/c06c11db912cc8/kubecost7.png)

その他、予算管理や異常検出などの機能もありますので、
興味あれば、[KubeCost のドキュメント](https://www.ibm.com/docs/en/kubecost/self-hosted/2.x?topic=navigating-kubecost-ui) を参照してください。

# Azure 上のコストとの統合

最後に、Azure 上のコストと KubeCost のコストを統合してみましょう。
先ほどのように Azure リソースの価格は小売価格 API で取得されています。

一方 Enterprise Agreement 契約などお客様において割引価格が適用されているケースもあるかと思います。
その内容を反映させなければ、Kubecost の内容が予想よりも高く出ているということがあり得ますので、
それを反映させる必要があります。

方法としては、1つあります。
従量課金プランでは検証には至りませんでしたが、前者の統合オプションの方では、
AKS 以外のコストも取り込め Kubecost でコストの配賦が可能なため、お薦めです。

1. Cost Management のエクスポートしたデータ (Blob) と統合
2. Azure Billing Rate Card API を利用

# まとめ

Kubecost を使うことで、AKS クラスター上のワークロードのコストを確認してみました。
ご契約形態に依りますが、Azure Const Management で集約するということで、AKS のコスト分析アドオンがお薦めです。

[Kubernetes のコストを表示する](https://learn.microsoft.com/ja-jp/azure/cost-management-billing/costs/view-kubernetes-costs)

## 参考

* [Allocating Azure ML Costs with Kubecost](https://techcommunity.microsoft.com/blog/appsonazureblog/allocating-azure-ml-costs-with-kubecost/4414623)














