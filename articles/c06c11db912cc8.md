---
title: "AKSのコスト管理"
emoji: "🐖"
type: "tech"
topics: ["Azure","AKS","FinOps"]
published: false
---

{ 
この記事の目的は、AKS（Azure Kubernetes Service）上で稼働するワークロードのコストを可視化・配賦する方法を分かりやすく示すことです。
対象読者は、AKSを運用するエンジニアやクラウドコスト管理に関心のある担当者です。

この記事の要点
- Azure の標準ツールだけでは名前空間／ラベル単位でのコスト配賦が難しい点を説明
- Kubecost（OpenCostベース）をAKSに導入してワークロード単位のコスト可視化を行う手順を示す
- Azure 側の価格差（企業契約による割引等）をKubecostに反映する方法を紹介

前提条件
- Azure サブスクリプションと適切な権限（リソース作成・AKS管理）
- kubectl / helm が利用できる環境
}

クラウドの管理において、セキュリティと併せて重要な要素がコスト管理です。
それなりの規模を持つシステムを管理する場合、多くは "共通基盤" (各ワークロードが共通で利用するリソースを集約) と、
"各業務ワークロード" (特定の業務に特化したリソース) に分けて管理されます。

このとき各業務ワークロードは、Azure においてはサブスクリプション レベルで分かれることが多く、
コストの割り当てもサブスクリプション毎で集計すればよいので容易です。

一方、Kubernetes は、ノードプールや名前空間によって複数の業務ワークロードが干渉しないように分けることが可能です。

![alt text](/images/c06c11db912cc8/kubecost1.png)


Kubernetes (Azure では Azure Kubernetes Service: AKS) クラスター毎やノード (仮想マシン) 毎のコストはプラットフォーム観点で集計できますが、
名前空間やラベルという観点では、Kubernetes のリソースをどのようにコスト集計するかが課題となります。

# モチベーション

Azure では、クラウドのコスト管理機能として [Azure Cost Management](https://learn.microsoft.com/ja-jp/azure/cost-management-billing/costs/overview-cost-management) が提供されています。
これで、Azure Kubernetes Servcie (AKS) のコストを見てみましょう。

![alt text](/images/c06c11db912cc8/kubecost2.png)

見ると、AKS (クラスター名 akslab1) とそれに紐づくノードプール (仮想マシン スケールセット) のコストは分かりますが、
やはりそれ以上の分解能はありません。

それでは、Kubernetes において稼働するワークロードのコストをどのようにはじき出すかを Azure 観点で紹介します。

## OpenCost / Kubecost

Kubernetes のコスト管理のトピックとして挙がるのが、OpenCost と Kubecost です。
OpenCost は CNCF によって管理されているオープンソースです。Kubecost は OpenCost をベースにエンタープライズ向けの機能 (アラートや、ガバナンス機能、予測と異常検出) を追加したプロダクトです。

[KubecostとOpenCostの比較](https://www.apptio.com/topics/kubernetes/cost-optimization/kubecost-vs-opencost/test)

Azure では OpenCost をベースとした[コスト分析アドオン](https://learn.microsoft.com/ja-jp/azure/aks/cost-analysis) が AKS で提供されていますが、
従量課金のプランでは利用できないため、ここでは Kubecost を試してみます。

> "Kubernetes のコストを表示する" より抜粋
> Kubernetes のコスト ビューは、次のサブスクリプション契約の種類でのみ使用できます。  
> - Enterprise Agreement  
> - Microsoft 顧客契約  
> 
> その他の契約はサポートされていません。

## Kubecost の導入

まずは、Azure に AKS クラスターをデプロイしましょう。
既に AKS クラスターを展開済みの方もいるかと思うので手順は折りたたんでおきます。

::::details 環境構築手順
:::message

リソース グループを作成

```bash
$ az group create --name rg-akslab --location japaneast
```

AKS をデプロイ

```bash
$ az aks create -g rg-akslab -n akslab1 --node-count 3 --ssh-key-value ..\.ssh\id_rsa.pub --attach-acr acrforakslab --node-vm-size standard_d4ds_v4
```

サンプルアプリケーションを投入

```bash
$ sudo az aks install-cli
$ az aks get-credentials --resource-group rg-akslab --name akslab1 --overwrite-existing

```bash
$ kubectl create namespace app
$ kubectl apply -f https://raw.githubusercontent.com/Azure-Samples/aks-store-demo/refs/heads/main/aks-store-quickstart.yaml -n app
```

アプリケーションの稼働を確認（Pod の STATUS が Running になることを確認）

```bash
$ kubectl get pods -n app
NAME                               READY   STATUS    RESTARTS   AGE
order-service-5c85f45984-cd2f7     1/1     Running   0          4m6s
product-service-5b8794b597-82hnp   1/1     Running   0          4m5s
rabbitmq-0                         1/1     Running   0          4m8s
store-front-6ff78d4f79-7xmjq       1/1     Running   0          4m3s
```

サービスの公開 IP を取得してブラウザで確認

```bash
$ kubectl get service store-front -n app -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
```

:::
::::

それでは、Kubecost を AKS クラスターにデプロイしてみましょう。
Helm チャートで提供されていますので、[[Helm のインストール]](https://helm.sh/docs/intro/install/)がまだでしたら、インストールしておきます。

下記コマンドで kubecost 名前空間に展開できます。

```bash
$ helm install kubecost cost-analyzer --repo https://kubecost.github.io/cost-analyzer/ --namespace kubecost --create-namespace
```

Pod が "Ready" になっているか確認します。
Kubecost は Prometheus からメトリックスを得てコスト分割を行っています。ビルトインで Prometheus と Grafana が展開されますが、
[既存の Prometheus を利用することも可能](https://www.ibm.com/docs/en/kubecost/self-hosted/2.x?topic=configuration-prometheus-guide)です。

```bash
$ kubectl get pods -n kubecost
NAME                                          READY   STATUS    RESTARTS   AGE
kubecost-cost-analyzer-5d679c857b-xjhg6       4/4     Running   0          2d4h
kubecost-forecasting-8cd68f7c5-6pm68          1/1     Running   0          2d4h
kubecost-grafana-5688b4fdb5-fbwft             2/2     Running   0          2d4h
kubecost-prometheus-server-6565bdcff4-xn57l   1/1     Running   0          2d4h
```

それでは Kubecost の Web インターフェースにアクセスします。
[公開することも可能](https://learn.microsoft.com/en-us/community/content/how-to-utilize-kubecost-for-cost-management-of-aks) ですが、ここでは ```kubectl port-foward``` にてローカルの Web ブラウザで ```http://localhost:9090``` を開きます。

```bash
$ kubectl port-forward --namespace kubecost deployment/kubecost-cost-analyzer 9090
```

![alt text](/images/c06c11db912cc8/kubecost3.png)

コスト割り当ての画面はこちら。
既定では名前空間 (Namespace) 毎に分類されています。

![alt text](kubecost4.png)

グルーピングの条件を例えばラベル毎に変更することも可能です。

![alt text](/images/c06c11db912cc8/kubecost5.png)

アセット (Assets) では Kubernetes クラスターを構成するコンポーネント (仮想マシンスケールセット、ロードバランサーなど) 毎のコストの内訳が確認できます。

![alt text](/images/c06c11db912cc8/kubecost6.png)

価格はどうやって取得しているのかというと、Azure の[小売り価格 API](https://learn.microsoft.com/ja-jp/rest/api/cost-management/retail-prices/azure-retail-prices) から取得していることが分かります。

```bash
$ kubectl logs kubecost-cost-analyzer-5d679c857b-n5xcz -n kubecost -f
...
27japaneast%27+and+armSkuName+eq+%27standard_d4ds_v4%27"
2025-08-22T08:43:20.269192099Z INF starting download retail price payload from "https://prices.azure.com/api/retail/prices?$skip=0&currencyCode='USD'&$filter=armRegionName+eq+%27japaneast%27+and+armSkuName+eq+%27standard_d4ds_v4%27"
```

さらに、節約 (Savings) のタブでは、各節約観点において月額辺りの節約予想額が見られます。
今のところ、AKS クラスターの機能のサポートはありませんが、節約の推奨に従い、
クラスターのサイジングや、名前空間のターンダウンの自動化が Actions から設定可能です。

![alt text](/images/c06c11db912cc8/kubecost7.png)

その他、予算管理や異常検出などの機能もありますので、
興味あれば、[KubeCost のドキュメント](https://www.ibm.com/docs/en/kubecost/self-hosted/2.x?topic=navigating-kubecost-ui) を参照してください。

## Azure 上のコストとの統合

最後に、Azure 上のコストと KubeCost のコストを統合してみましょう。
先ほどのように Azure リソースの価格は小売価格 API で取得されています。

一方 Enterprise Agreement 契約などお客様において割引価格が適用されているケースもあるかと思います。
その内容を反映させなければ、Kubecost の内容が予想よりも高く出ているということがあり得ますので、
それを反映させる必要があります。

方法としては、1つあります。
従量課金プランでは検証には至りませんでしたが、前者の統合オプションの方では、
AKS 以外のコストも取り込め Kubecost でコストの配賦が可能なため、お薦めです。

1. Cost Management のエクスポートしたデータ (Blob) と統合
2. Azure Billing Rate Card API を利用

## 参考

* [Allocating Azure ML Costs with Kubecost](https://techcommunity.microsoft.com/blog/appsonazureblog/allocating-azure-ml-costs-with-kubecost/4414623)












