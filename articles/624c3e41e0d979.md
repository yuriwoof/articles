---
title: "è‡ªå®…ãƒã‚¤ã‚¯ãƒ©ã‚µãƒ¼ãƒ ã‚’Azureã«ç§»è¡Œ"
emoji: "ğŸ‘¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Minecraft","Azure","Docker"]
published: false
---

ã“ã‚“ã«ã¡ã‚ğŸ„
ã“ã®è¨˜äº‹ã¯ã€[Azure Advent Calnedar 2023](https://qiita.com/advent-calendar/2023/microsoft-azure-tech) ã® 12/7 ã®è¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚

## ã¯ã˜ã‚ã«

è‡ªå®…ã§é‹ç”¨ã—ã¦ã„ã‚‹(åˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç§ã¨å­ã©ã‚‚ã®2å)ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«è¼‰ã›ãŸã‚‰ã€ã©ã®ã‚ˆã†ãªæ§‹æˆã«ãªã‚‹ã‹ã€ç§»è¡Œæ–¹æ³•ã‚’èª¿ã¹ã‚‹ãŒã¦ã‚‰è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

## è¦ä»¶ã®æ•´ç†

è‡ªå®…ã§ã¯ã€Javaç‰ˆ(ç§)ã¨çµ±åˆç‰ˆ(å­ã©ã‚‚)ã§éŠã‚“ã§ãŠã‚Šã€åŒæ–¹ã‹ã‚‰éŠã¹ã‚‹ã¨ã„ã†è¦ä»¶ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã« [Geyser](https://geysermc.org/) ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å…¥ã‚Œã¦ã€çµ±åˆç‰ˆã‹ã‚‰ Java ç‰ˆã®ã‚µãƒ¼ãƒã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¾ã™ã€‚

:::message
Geyser ã¯ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ãªã‚‹ãŸã‚ã€ä½¿ç”¨ã«éš›ã—ã¦ã¯è‡ªå·±è²¬ä»»ã§ä½¿ã£ã¦ãã ã•ã„ã€‚
:::

ãã®ãŸã‚ã€é€šä¿¡è¦ä»¶ã¨ã—ã¦ Java ç‰ˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã¯ ```25565/TCP``` ã€çµ±åˆç‰ˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã¯ ```19132/UDP``` ã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãŸã€World ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![Home base](/images/624c3e41e0d979/image.png)

æ‹ ç‚¹ã®æ‘äººã•ã‚“ãŸã¡ã€€ã€Œãƒ•ã‚¥ãƒ¼ãƒ³ã€Azure ã£ã¦ã©ã‚“ãªã¨ã“ã‚ãªã‚“ã ã‚ã†ã€

## Microsoft Copilot for Azureã§ç›¸è«‡

ç§»è¡Œå…ˆã®æŠ€è¡“é¸å®šã«ã¤ã„ã¦ã¯ã€ç¾åœ¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã® [Microsoft Copilot for Azure](https://techcommunity.microsoft.com/t5/azure-infrastructure-blog/simplify-it-management-with-microsoft-copilot-for-azure-save/ba-p/3981106) ã§ç›¸è«‡ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ãªãŠç¾åœ¨åˆ©ç”¨ã«éš›ã—ã¦ã¯ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ã®å‚åŠ ç”³è«‹ã¨ã€ä»¥ä¸‹ã®åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚

å‚è€ƒ; [ç¾åœ¨ã®åˆ¶é™ - Microsoft Copilot for Azure (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼) æ©Ÿèƒ½](https://learn.microsoft.com/ja-jp/azure/copilot/capabilities#current-limitations)

>ç¾åœ¨ã®åˆ¶é™äº‹é …ã«ç•™æ„ã—ã¦ãã ã•ã„ã€‚
>
>ãƒ»ç¾åœ¨ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¯¾è©±ã¯ã€ä¼šè©±ã”ã¨ã« 10 å›ã®è³ªå•ã€1 æ—¥ã« 5 å›ã®ä¼šè©±ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚
>ãƒ»ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ä¸€éƒ¨ã®å¿œç­”ã¯ã€ä¸Šä½ 5 é …ç›®ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚
>ãƒ»ä¸€éƒ¨ã®ã‚¿ã‚¹ã‚¯ã¨ã‚¯ã‚¨ãƒªã§ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã®åå‰ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚ã¾ãŸã€Azure ãƒªã‚½ãƒ¼ã‚¹ ID ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
>ãƒ»Microsoft Copilot for Azure (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼) ã¯ç¾åœ¨ã€è‹±èªã§ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚

ã¾ãšã¯ã–ã£ãã‚Šç›¸è«‡ã—ã¦ã¿ã¾ã—ãŸã€‚

```
I want to migrate Minecraft server (Docker container) running on-premises. It is necessary to allow 25565/TCP and 19132/UDP as network requirement. What should I do?
```

![Alt text](/images/624c3e41e0d979/image-1.png)

ãŠãŠã€Azure Kubernetes Service ã‚„ Azure Container Instance ã¯ãŠè–¦ã‚ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

ãã—ã¦ã€[Azure ã§ã®ã‚²ãƒ¼ãƒ  ã‚µãƒ¼ãƒãƒ¼ã®åŸºæœ¬çš„ãªãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°](https://learn.microsoft.com/ja-jp/gaming/azure/reference-architectures/multiplayer-basic-game-server-hosting?wt.mc_id=knwlserapi_inproduct_azportal#step-by-step) ã‚„ Minecraft ã‚µãƒ¼ãƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (server.properties) ã¾ã§æ•™ãˆã¦ãã‚Œã¾ã—ãŸã€‚
çµæœçš„ã«ã¯ VM ã‚’é¸æŠã™ã‚‹ã®ã§ã™ãŒã€ã‚‚ã†å°‘ã—èã„ã¦ã¿ã¾ã™ã€‚

Azure Container Instance ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ä¾‹ã‚’è¦‹ã‹ã‘ãŸã®ã§ã€
ã“ã¡ã‚‰ãªã©ã¯ã©ã†ã‹ã¨èã„ã¦ã¿ã¾ã—ãŸã€‚

![Alt text](/images/624c3e41e0d979/image-2.png)

Application Gateway ã¯ L7 ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ãªã®ã§ã€Azure Load Balancer ã¯ä½¿ãˆã‚‹ã‹ã€‚

![Alt text](/images/624c3e41e0d979/image-3.png)

ã§ãã‚‹ã ..ã¨ï¼Ÿ ãŸã ã“ã‚Œã¯ã€[ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚·ãƒŠãƒªã‚ª - ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚·ãƒŠãƒªã‚ªã¨ãƒªã‚½ãƒ¼ã‚¹](https://learn.microsoft.com/ja-jp/azure/container-instances/container-instances-virtual-network-concepts#unsupported-networking-scenarios) ã«ã‚ã‚‹é€šã‚Šã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã‚·ãƒŠãƒªã‚ªã§ã‚ã‚‹ãŸã‚ã€å³ä¸‹ã® down vote ã‚’æŠ¼ã—ã¦ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ã‚Šã¾ã—ãŸã€‚ã“ã¡ã‚‰ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ã‚‹ã“ã¨ã§é–‹ç™ºå…ƒã«ç›´æ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒé€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![Alt text](/images/624c3e41e0d979/image-4.png)

åŒã˜ã‚ˆã†ã« Azure Container Apps ã«ã¤ã„ã¦ã‚‚ã€UDP ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚‰ãšã€WebApp for Container ã‚‚ TCP/UDP ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã¨ã‚ã‹ã‚Šã¾ã—ãŸã€‚
è³ªå•ã®ä»•æ–¹ã«ã‚ˆã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã§ä»•æ§˜ã‚’ç¢ºèªã™ã‚‹åˆ†ã«ã¯ã€ç”³ã—åˆ†ãªã„ã§ã™ã€‚

---

æ¬¡ã« VM ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹å‘ã§ãã®æ–¹æ³•ã‚’è³ªå•ã—ã¦ã¿ã¾ã™ã€‚
å³ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ "New chat" ã‚’é¸æŠã—ã€æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

![Alt text](/images/624c3e41e0d979/image-5.png)

![Alt text](/images/624c3e41e0d979/image-6.png)

![Alt text](/images/624c3e41e0d979/image-7.png)

çµæœçš„ã« Azure Bicep ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†æ–¹æ³•ã§è³ªå•ã—ã¦ã„ã¾ã—ãŸãŒã€
Bicep ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ææ¡ˆã„ãŸã ãã«ã¯ã€å®Ÿéš›ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ•™ãˆã¦ã»ã—ã„æ—¨ã‚’ä¼ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ãŸã ã€Bicep ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç”Ÿæˆè‡ªä½“ã¯æ©Ÿèƒ½ã«è¬³ã£ã¦ã„ãªã„ãŸã‚ã€æœŸå¾…ã•ã‚ŒãŸå¿œç­”ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

[ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œ - Microsoft Copilot for Azure (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼) æ©Ÿèƒ½](https://learn.microsoft.com/ja-jp/azure/copilot/capabilities)

### ç§»è¡Œã®å®Ÿè¡Œ

ç§»è¡Œå…ˆã®ã‚¤ãƒ³ãƒ•ãƒ©ä¸€å¼ã‚’å…ˆã«ææ¡ˆã—ã¦ã‚‚ã‚‰ã£ãŸ Bicep ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (éƒ¨åˆ†çš„ã«å¤‰æ›´) ã§å±•é–‹ã—ã¾ã™ã€‚
ä½¿ã£ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚„ Docker Compose ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€[ã“ã¡ã‚‰](https://github.com/yuriwoof/minecraft-server.git) ã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚

```bach
$ az group create -n labmc -l japaneast
$ az deployment group create -g labmc --template-file ./minecraft-server/bicep/deploymcvm.bicep
```

å±•é–‹ãŒå®Œäº†ã—ãŸã‚‰ã€æ¬¡ã¯ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œã§ã™ã€‚
ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ Mincecraft ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã—ã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ ```data``` ã‚’åœ§ç¸®ã—ã€
Azure VM ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚


```bash
$ scp minecraft-server/docker-compose.yaml azureuser@(ä»®æƒ³ãƒã‚·ãƒ³ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹):/home/azureuser
$ cd (ãƒ­ãƒ¼ã‚«ãƒ«ã® Minecraft ã‚µãƒ¼ãƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•)
$ tar -czvf data.tgz data/ 
$ ls -lh
total 2.4G
drwxrwxrwx 1 yurio yurio  512 Dec  4 07:07 data
-rwxrwxrwx 1 yurio yurio 2.4G Dec  4 07:15 data.tgz
-rwxrwxrwx 1 yurio yurio 1.7K Dec  4 06:59 docker-compose.yml
drwxrwxrwx 1 yurio yurio  512 Apr 29  2023 mc-backups
-rwxrwxrwx 1 yurio yurio  261 Sep 24 15:53 mods.txt
-rwxrwxrwx 1 yurio yurio  128 Mar 26  2023 start.sh
$ scp data.tgz azureuser@(ä»®æƒ³ãƒã‚·ãƒ³ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹):/home/azureuser             
```

æ¬¡ã¯ ã‚µãƒ¼ãƒå´ã§ã®è¨­å®šã«ç§»ã‚Šã¾ã™ã€‚
Geyser ã®èµ·å‹•ãŒç¢ºèªã§ãã¾ã—ãŸã‚‰ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ Minecrat (Java ç‰ˆ / çµ±åˆç‰ˆ)ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‹ç¢ºèªã—ã¾ã™ã€‚

```bash
azureuser@mcsvr:~$ tar -xzvf data.tgz
azureuser@mcsvr:~$ ls -l
total 2469448
drwxrwxr-x 13 azureuser azureuser       4096 Dec  3 22:07 data
-rwxrwxr-x  1 azureuser azureuser 2528698760 Dec  4 08:58 data.tgz
-rw-r--r--  1 azureuser azureuser        816 Dec  4 09:03 docker-compose.yaml
azureuser@mcsvr:~$ docker compose up
...

mc-server  | [18:08:09 INFO]: [Geyser-Spigot] ******************************************
mc-server  | [18:08:09 INFO]: [Geyser-Spigot] 
mc-server  | [18:08:09 INFO]: [Geyser-Spigot] Loading Geyser version 2.2.0-SNAPSHOT (git-master-b8481cc)
mc-server  | [18:08:09 INFO]: [Geyser-Spigot] 
mc-server  | [18:08:09 INFO]: [Geyser-Spigot] ******************************************
mc-server  | [18:08:22 INFO]: [Geyser-Spigot] Started Geyser on 0.0.0.0:19132
mc-server  | [18:08:22 INFO]: [Geyser-Spigot] Done (12.187s)! Run /geyser help for help!
mc-server  | [18:08:22 INFO]: Done (46.870s)! For help, type "help"
mc-server  | [18:08:22 INFO]: Starting GS4 status listener
mc-server  | [18:08:22 INFO]: Thread Query Listener started
mc-server  | [18:08:22 INFO]: Query running on 0.0.0.0:25565
mc-server  | [18:08:22 INFO]: Starting remote control listener
mc-server  | [18:08:22 INFO]: Thread RCON Listener started
mc-server  | [18:08:22 INFO]: RCON running on 0.0.0.0:25575
mc-server  | [Rcon loop] MCServer is listening, running startup
mc-server  | [Rcon loop] running - gamerule playersSleepingPercentage 1
mc-server  | [18:08:22 INFO]: Thread RCON Client /127.0.0.1 started
mc-server  | [18:08:23 INFO]: [Rcon: Gamerule playersSleepingPercentage is now set to: 1]
mc-server  | [Rcon loop] Gamerule playersSleepingPercentage is now set to: 1
mc-server  | [Rcon loop] running - setworldspawn -424 68 2257
mc-server  | [18:08:23 INFO]: Thread RCON Client /127.0.0.1 shutting down
mc-server  | [18:08:23 INFO]: Thread RCON Client /127.0.0.1 started
mc-server  | [18:08:24 INFO]: [Rcon: Set the world spawn point to -424, 68, 2257 [0.0]]
mc-server  | [18:08:24 INFO]: Thread RCON Client /127.0.0.1 shutting down
mc-server  | [Rcon loop] Set the world spawn point to -424, 68, 2257 [0.0]
mc-server  | [Rcon loop] No addition rcon commands are given, stopping rcon cmd service
```

Java ç‰ˆã‹ã‚‰ã“ã‚“ã«ã¡ã‚

![Alt text](/images/624c3e41e0d979/image-8.png)

çµ±åˆç‰ˆã‹ã‚‰ã‚‚ã“ã‚“ã«ã¡ã‚ã€‚

![Alt text](/images/624c3e41e0d979/image-9.png)

ã¨ã„ã†ã“ã¨ã§ç§»è¡Œã§ãã¾ã—ãŸã€‚

### ã¾ã¨ã‚

Azure Copilot for Azure ã¯ä¸Šè¨˜ã®ã‚ˆã†ãªè¨­è¨ˆã®ç›¸è«‡ä»¥å¤–ã«ã‚‚ã€
ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚„ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ç›¸è«‡ãªã©ã‚‚ã§ãã‚‹ã®ã§ã€ã©ã—ã©ã—ã”åˆ©ç”¨&ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã„ãŸã ã„ã¦ã€ã‚ˆã‚Šè‰¯ã„ Azure ãƒ©ã‚¤ãƒ•ã‚’ãŠé€ã‚Šãã ã•ã„ğŸ…
