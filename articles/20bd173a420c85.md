---
title: "Hybrid Runbook Worker で Arc マシン内の PowerShell スクリプトを実行する"
emoji: "🤖"
type: "tech"
topics: ["Azure", "AzureArc", "AzureAutomation", "PowerShell", "HybridRunbookWorker"]
published: true
---

今回は、Hybrid Runbook Worker [^1] を通して、Azure Azc 対応サーバー上の PowerShell スクリプトを実行しようというやつです。
これによって、実行されるマシン上の任意の PowerShell スクリプトを Azure から実行できるようになります。

## はじめに

オンプレミスや他のクラウド環境にあるサーバーに対して、Azure から自動化タスクを実行したいケースは多いと思います。これを実現する方法として実行コマンド拡張機能というものもあるのですが、Hybrid Runbook Worker の方がジョブのキューイングやスケジュールといった、よりジョブ管理に特化した面を持っています。
なお、Azure Automation 自体は、クラウドリソースに対する自動化タスクを支援するクラウド オートメーションと、ゲストに対する自動化を Hybrid Runbook Worker 機能があります。

## Hybrid Runbook Worker とは

Hybrid Runbook Worker の主な特徴は下記になります。

- ローカル実行: Azure 以外の環境（オンプレミス、他のクラウド）にあるマシン上で直接 Runbook を実行
- ローカルリソースへのアクセス: ファイアウォールの内側にあるリソースへのアクセスが可能
- 拡張機能ベース: Azure Arc 対応サーバーでは VM 拡張機能として簡単にデプロイ可能

![alt text](/images/20bd173a420c85/auto1.png)

## 前提条件

- Azure Arc 対応サーバーが登録されていること
- Azure Arc サーバーにシステム割り当てのマネージド ID が有効化されていること
- Azure サブスクリプションへのアクセス権限

## 構成手順

さてここからは実際の設定も踏まえて紹介します。

### 1. Azure Automation アカウントのデプロイ

最初に、Runbook を管理するための Automation アカウントを作成します。

1. Azure ポータルの検索バーで"automation"と検索し、"Automation アカウント"を選択
2. "+ 作成"を選択
3. 以下の情報を入力
   - サブスクリプション: 使用するサブスクリプション
   - リソース グループ: 既存または新規のリソースグループ
   - Automation アカウント名: 任意の名前（例: `hybridaalab`）
   - リージョン: Japan East など
4. "確認と作成"→"作成"

### 2. Hybrid Runbook Worker グループの作成

次に、Hybrid Runbook Worker グループを作成し、Azure Arc 対応サーバーを登録します。
このグループに含まれる Worker に対して Runnbook を実行するジョブが割り当てられます。
グループに複数の Worker が存在する場合、ジョブの先着順にジョブを処理しています。

また、資格情報でカスタムを選択したことにより、特定のユーザーとして Runbook を実行できます。
今回はローカルアカウントですが、ドメインアカウントの指定もサポートされています。

1. 作成した Automation アカウントを開く
2. 左メニューの"プロセス オートメーション"→"ハイブリッド Worker グループ"を選択
3. "+ ハイブリッド Worker グループの作成"を選択
4. 基本 タブで以下を設定
   - 名前: 任意のグループ名（例: `hybridarcgroup`）
   - ハイブリッド worker の資格情報の使用: カスタム
   - ハイブリッド worker 資格情報の選択: "+ 資格情報の追加"
     - 名前: 資格情報名（例: `wincert`）
     - ユーザー名: 実行ユーザー（例: `Administrator`）
     - パスワード/パスワードの確認入力: パスワードを入力
5. "次へ"を選択し、ハイブリッド worker タブへ
6. "+ マシンの追加"を選択し、対象の Azure Arc 対応サーバーにチェックを入れて"追加"
7. "次へ"→"作成"

作成が完了すると、対象の Azure Arc 対応サーバーに HybridWorker 拡張機能 が自動的にインストールされます。

:::message
Azure Arc 対応サーバーの"拡張機能"から、HybridWorker 拡張機能がインストールされていることを確認できます。
:::

![alt text](/images/20bd173a420c85/auto2.png)

### 3. 対象マシンに PowerShell スクリプトを配置

Hybrid Runbook Worker から呼び出すスクリプトを、対象サーバー上に配置します。
例として、`C:\Scripts\Get-CurrentInfo.ps1` に以下のスクリプトを配置します。

```powershell
# Get-CurrentInfo.ps1
# 現在の時刻とユーザー情報を表示するスクリプト

# 現在の時刻を表示（フォーマット指定）
$currentTime = Get-Date -Format "yyyy/MM/dd HH:mm:ss"
Write-Output "現在の時刻: $currentTime"

# 現在のユーザーを表示
$currentUser = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
Write-Output "現在のユーザー: $currentUser"
```

![alt text](/images/20bd173a420c85/auto3.png)
![alt text](/images/20bd173a420c85/auto4.png)

### 4. Runbook の登録

そしてローカルスクリプトを実行するための Runbook を作成します。

1. Automation アカウントの"プロセス オートメーション"→"Runbook"を選択
2. "+ 作成"を選択
3. 以下の情報を入力
   - 名前: `runbook-execute-local-script`
   - Runbook の種類: PowerShell
   - ランタイム環境: PowerShell 5.1 または 7.2
4. "作成"を選択

以下の Runbook コードを入力します。

```powershell
# Runbook: Arc サーバー上の特定の PowerShell スクリプトを実行
# このスクリプトは Hybrid Runbook Worker 上で実行されます

param(
    [Parameter(Mandatory=$true)]
    [string]$ScriptPath,
    
    [Parameter(Mandatory=$false)]
    [hashtable]$ScriptParameters = @{}
)

Write-Output "========================================="
Write-Output "Hybrid Runbook Worker でスクリプトを実行"
Write-Output "========================================="
Write-Output "実行日時: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
Write-Output "コンピューター名: $env:COMPUTERNAME"
Write-Output "スクリプトパス: $ScriptPath"
Write-Output "-----------------------------------------"

try {
    # スクリプトファイルの存在確認
    if (-not (Test-Path -Path $ScriptPath)) {
        throw "スクリプトが見つかりません: $ScriptPath"
    }
    
    Write-Output "スクリプトファイルを確認しました: $ScriptPath"
    
    # スクリプトの実行
    Write-Output "スクリプトを実行中..."
    
    if ($ScriptParameters.Count -gt 0) {
        Write-Output "パラメーター:"
        $ScriptParameters.GetEnumerator() | ForEach-Object {
            Write-Output "  $($_.Key) = $($_.Value)"
        }
        
        $result = & $ScriptPath @ScriptParameters
    }
    else {
        $result = & $ScriptPath
    }
    
    Write-Output "-----------------------------------------"
    Write-Output "実行結果:"
    Write-Output $result
    Write-Output "-----------------------------------------"
    Write-Output "スクリプトの実行が正常に完了しました"
    
    return $result
}
catch {
    Write-Error "スクリプトの実行中にエラーが発生しました: $_"
    Write-Error $_.ScriptStackTrace
    throw
}
finally {
    Write-Output "========================================="
    Write-Output "実行終了: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
    Write-Output "========================================="
}
```

5. "保存"→"公開"を選択して Runbook を公開

### 5. Runbook の実行

1. 公開した Runbook を選択し、"開始"をクリック
2. 以下のパラメーターを設定
   - SCRIPTPATH: `C:\Scripts\Get-CurrentInfo.ps1`
   - ScriptParameters: 実行するスクリプトに渡すパラメータを指定
   - 実行対象: Hybrid ワーカー
   - Hybrid Worker グループ: 作成したグループを選択
3. "OK"をクリックして実行

![alt text](/images/20bd173a420c85/auto5.png)

実行が完了すると、"ジョブ"から出力結果を確認できます。

![alt text](/images/20bd173a420c85/auto6.png)

## Azure CLI での Runbook 実行

Azure CLI を使用して Runbook を実行することも可能です。

```bash
az automation runbook start \
  --resource-group rg-arclab1 \
  --automation-account-name hybridaalab \
  --name Execute-LocalScript \
  --run-on hybridarcgroup \
  --parameters '{"ScriptPath":"C:\\Scripts\\Get-CurrentInfo.ps1"}'
```

## GitHub との連携（ソース管理）

Runbook を GitHub または Azure DevOps と連携することで、コードのバージョン管理と自動同期が可能です [^4]。
自動同期の場合、コミットされたタイミングで Runbook が更新されます。
その他には手動による同期ができます。

**ソース管理のメリット**

- バージョン管理: Runbook の変更履歴を追跡可能
- コードレビュー: Pull Request によるレビュープロセスの導入
- 自動同期: GitHub への push 時に自動で Runbook を更新
- Infrastructure as Code: Runbook をコードとして管理

**GitHub 連携の前提条件**

- GitHub リポジトリが作成されていること
- GitHub Personal Access Token（PAT）が発行されていること（`repo` スコープが必要）

## RBAC によるアクセス制御

Azure Automation では、Azure ロールベースのアクセス制御（RBAC）を使用して、Runbook の実行や管理に対するアクセス権限を細かく制御できます [^5]。

**Automation 関連の組み込みロール**

| ロール | 説明 |
|--------|------|
| Automation オペレーター | Runbook の開始、停止、中断、再開が可能。Runbook の編集や作成は不可 |
| Automation Runbook オペレーター | Runbook のプロパティの読み取りと Runbook ジョブの作成が可能 |
| Automation ジョブ オペレーター | Automation ジョブの作成と管理が可能 |
| Automation 共同作成者 | Automation リソースの作成と管理が可能（Runbook の編集含む） |

**運用シナリオ例**

| シナリオ | 推奨ロール |
|---------|----------|
| 開発者が Runbook を作成・編集 | Automation 共同作成者 |
| 運用担当者が Runbook を実行のみ | Automation オペレーター |
| 監視システムからジョブを自動実行 | Automation ジョブ オペレーター |
| 読み取り専用でジョブ結果を確認 | 閲覧者 |

:::message
**最小権限の原則**: 運用環境では、ユーザーやサービスプリンシパルに必要最小限の権限のみを付与することを推奨します。
:::

## トラブルシューティング [^2]

### Hybrid Worker が表示されない場合

1. Azure Arc サーバーで Hybrid Worker Extension がインストールされているか確認
2. Azure Arc サーバーの Managed Identity が有効になっているか確認

Azure CLI で以下のように、"SyStemAssigned" タイプの Managed Identity が有効化されていることを確認できます。

```bash
$ az connectedmachine show \
  --resource-group <リソース グループ名> \
  --name <Azure Arc 対応サーバー名> \
  --query "identity"
{
  "principalId": "<プリンシパル ID>",
  "tenantId": "<テナント ID>",
  "type": "SystemAssigned"
}
```

3. Automation アカウントの"Hybrid Worker Groups"を確認

### ジョブが失敗する場合

1. Runbook のログを確認
2. スクリプトパスが正しいか確認
3. 実行権限があるか確認
4. PowerShell 実行ポリシーを確認

```powershell
# Arc サーバー上で実行
Get-ExecutionPolicy
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope LocalMachine
```

### カスタム資格情報を使用する場合の注意

カスタム資格情報を使用する場合、以下のフォルダーへのアクセス許可が必要です [^3]。

| フォルダーパス | アクセス許可 |
|--------------|------------|
| `C:\ProgramData\AzureConnectedMachineAgent\Tokens` | 読み取り |
| `C:\Packages\Plugins\Microsoft.Azure.Automation.HybridWorker.HybridWorkerForWindows` | 読み取りと実行 |

## まとめ

いかがでしたでしょうか。導入も比較的容易だったかと思います。
これでオンプレスのマシンに対するジョブ管理をクラウドに集約するということも可能になります。

活用シナリオ:
- 定期的なメンテナンスタスクの自動化
- 監視アラートに応じた自動対応
- サーバー情報の収集とレポート作成
- アプリケーションのデプロイや構成変更

ぜひ、ハイブリッド環境の自動化に活用してください。

[^1]: [Azure Automation Hybrid Runbook Worker の概要](https://learn.microsoft.com/ja-jp/azure/automation/automation-hybrid-runbook-worker)
[^2]: [トラブルシューティング ガイド: Azure Automation Hybrid Runbook Worker](https://learn.microsoft.com/ja-jp/azure/automation/automation-hybrid-runbook-worker-troubleshoot)
[^3]: [シナリオ: ユーザー アカウント制御 (UAC) が有効になっているサーバーでカスタム アカウントを使用すると、Runbook が Hybrid Runbook Worker で中断状態になる](https://learn.microsoft.com/ja-jp/azure/automation/troubleshoot/extension-based-hybrid-runbook-worker#scenario-runbooks-go-into-a-suspended-state-on-a-hybrid-runbook-worker-when-using-a-custom-account-on-a-server-with-user-account-control-uac-enabled)
[^4]: [Azure Automation のソース管理を使用して Runbook を GitHub リポジトリと同期する](https://learn.microsoft.com/ja-jp/azure/automation/source-control-integration)
[^5]: [Azure Automation におけるロールベースのアクセス制御](https://learn.microsoft.com/ja-jp/azure/automation/automation-role-based-access-control)