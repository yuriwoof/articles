---
title: "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒªãƒ³ã‚¯çµŒç”±ã§Azure CLIã‚ˆã‚Šæ“ä½œ"
emoji: "ğŸš§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Azure", "AzureCLI"]
published: true
---

å¤–éƒ¨é€šä¿¡è¦ä»¶ãŒå³ã—ã„ç’°å¢ƒã§åˆã£ãŸã‚Šã™ã‚‹å ´åˆã§ã‚‚ä½•ã¨ã‹Azure CLI/Azure PowerShellã‚’ä½¿ã„ãŸã„ã¨ã„ã†è¦æœ›ãŒã‚ã‚Šã€ä»¥ä¸‹ã®å†…å®¹ã‚’æ‰‹å…ƒã§ç¢ºèªã‚’è¡Œã£ãŸãŸã‚è‡ªåˆ†å®›ã¦ã«ãƒ¡ãƒ¢ã¨ã—ã¦æ®‹ã—ã¦ãŠãã€‚[^1]

ã¯ã˜ã‚ã«Azure ãƒãƒ¼ã‚¿ãƒ«ã®æ“ä½œã‚’å«ã‚ã€Azure APIã‚’ç”¨ã„ãŸæ“ä½œã¯ã™ã¹ã¦Azure Resource Manager (ä»¥é™ã€ARM)ã‚’é€šã—ã¦è¡Œã‚ã‚Œã‚‹ã€‚[^2]

![Azure Resource Manager](/images/1f3283a973bd69/image.png)

ã“ã‚Œã¾ã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ ARM ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¾ã§ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§ã‚ã£ãŸãŒã€
ã“ã‚Œã‚’ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”± (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹é€šä¿¡) ã«ã§ãã‚‹ã¨ã„ã†è©±ã€‚

ãªãŠã€æ—¢ã«å…ˆäººã®æ–¹ãŒç¯‰ã„ãŸè³‡ç”£ãŒå¤§åˆ†å‚è€ƒã«ãªã£ãŸã®ã§ã“ã“ã«ã”ç´¹ä»‹ã€‚[^3]

## å‰æº–å‚™

ãƒ«ãƒ¼ãƒˆç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«å¯¾ã—ã¦æ‰€æœ‰è€…ã¾ãŸã¯å…±åŒç®¡ç†è€…æ¨©é™ã‚’æŒã¤å¿…è¦ãŒã‚ã‚‹ã€‚[^4]

ãã®ãŸã‚ã«ã¯ã€æ“ä½œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ˜‡æ ¼ã•ã›ã€ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚[^5]

![Alt text](/images/1f3283a973bd69/image-2.png)

ãã®å¾Œã€ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦ã‚’è¡Œã†ã€‚

```bash
az role assignment create --assignee "<ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«å" --role Owner --scope "/providers/Microsoft.Management/managementGroups/<Azure AD ãƒ†ãƒŠãƒ³ãƒˆID>"
```

## è¨­å®š

ä»Šå›ã¯äºˆã‚ `labrmpl` ã¨ã„ã†åå‰ã®ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ãŠã‚Šã€ãã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒªãƒ³ã‚¯ã®ä½œæˆ

```bash
$ az resourcemanagement private-link create -g labrmpl -n labrmpl -l japaneast
{
  "id": "/subscriptions/<ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID>/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl",
  "location": "japaneast",
  "name": "labrmpl",
  "properties": {
    "privateEndpointConnections": []
  },
  "resourceGroup": "labrmpl",
  "type": "Microsoft.Authorization/resourceManagementPrivateLinks"
}
```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒªãƒ³ã‚¯é–¢é€£ä»˜ã‘ã®ä½œæˆ

åå‰ã¯GUIDã®å½¢å¼ã‚’å–ã‚‹ãŸã‚ã€äºˆã‚ `uuidgen` ã‚³ãƒãƒ³ãƒ‰ãªã©ã§ç”Ÿæˆã—ã¦ãŠãã€‚ã¾ãŸã€`--public-network-access` ç¾æ™‚ç‚¹ã§ã¯ `enabled` ã—ã‹æŒ‡å®šã§ããªã„ (æã‚‰ã `disabled` ãŒæŒ‡å®šã§ãã‚Œã°ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã§ãã‚‹æƒ³å®šã ãŒã€ãƒ‡ãƒƒãƒˆãƒ­ãƒƒã‚¯ã‚’æ‹›ããã†...)

```bash
$ az private-link association create --management-group-id <Azure ADãƒ†ãƒŠãƒ³ãƒˆ ID> --name <ç”¨æ„ã—ãŸGUID> --privatelink /subscriptions/<ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID>/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl --public-network-access enabled
{
  "id": "/providers/Microsoft.Management/managementGroups/<Azure ADãƒ†ãƒŠãƒ³ãƒˆ ID>/providers/Microsoft.Authorization/privateLinkAssociations/<ç”¨æ„ã—ãŸGUID>",
  "name": "<ç”¨æ„ã—ãŸGUID>",
  "properties": {
    "privateLink": "/subscriptions/<ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID>/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl",
    "publicNetworkAccess": "Enabled",
    "scope": "/providers/Microsoft.Management/managementGroups/<Azure ADãƒ†ãƒŠãƒ³ãƒˆ ID>",
    "tenantId": "<Azure ADãƒ†ãƒŠãƒ³ãƒˆ ID>"
  },
  "type": "Microsoft.Authorization/privateLinkAssociations"
}
```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã€ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œæˆã™ã‚‹ã€‚

```bash
$ az network vnet create -g labrmpl -l japaneast -n clivnet --address-prefixes 10.0.0.0/16 --subnet-name default --subnet-prefixes 10.0.0.0/24
```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆ
`10.0.0.4` ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

```bash
$ id=$(az resourcemanagement private-link show -g labrmpl -n labrmpl --query 'id' -o tsv)
$ az network private-endpoint create --connection-name rmplconnect -n rmplpe --private-connection-resource-id $id -g labrmpl --subnet default --group-id ResourceManagement --vnet-name clivnet

...(çœç•¥)...

  "customDnsConfigs": [
    {
      "fqdn": "management.azure.com",
      "ipAddresses": [
        "10.0.0.4"
      ]
    },
    {
      "fqdn": "edge.management.azure.com",
      "ipAddresses": [
        "10.0.0.4"
      ]
    }
  ],

...(çœç•¥)...

```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ DNS ã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆ

```bash
$ az network private-dns zone create -g labrmpl -n "privatelink.azure.com"
$ az network private-dns link vnet create -g labrmpl -z "privatelink.azure.com" -n dns-link -v clivnet -e false
$ az network private-endpoint dns-zone-group create -g labrmpl --endpoint-name rmplpe -n zone-group --private-dns-zone "privatelink.azure.com" --zone-name rmpl

...(çœç•¥)...
      "recordSets": [
        {
          "fqdn": "management.privatelink.azure.com",
          "ipAddresses": [
            "10.0.0.4"
          ],
          "provisioningState": "Succeeded",
          "recordSetName": "management",
          "recordType": "A",
          "ttl": 10
        },
        {
          "fqdn": "edge.management.privatelink.azure.com",
          "ipAddresses": [
            "10.0.0.4"
          ],
          "provisioningState": "Succeeded",
          "recordSetName": "edge.management",
          "recordType": "A",
          "ttl": 10
        }
      ]
    }
  ],

...(çœç•¥)...
```

## ç¢ºèª

ã“ã“ã‹ã‚‰ã¯ç¢ºèªã®ãŸã‚ã€ä»®æƒ³ãƒã‚·ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—å‹•ä½œã‚’è¦‹ã¦ã¿ã‚‹ã€‚

```bash
$ az vm create -g labrmpl -n clivm --image Ubuntu2204 --vnet-name clivnet --subnet default --admin-username azureuser --ssh-key-value ~/.ssh/id_rsa.pub
```

```bash
azureuser@clivm:~$ nslookup management.azure.com
Server:         127.0.0.53
Address:        127.0.0.53#53

Non-authoritative answer:
management.azure.com    canonical name = management.privatelink.azure.com.
Name:   management.privatelink.azure.com
Address: 10.0.0.4
```

Azure CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«[^6]ã—ã¦æ“ä½œã‚’ç¢ºèª
å‚è€ƒã«ã—ãŸè¨˜äº‹ã§ã¯ã€ã‚·ã‚¹ãƒ†ãƒ  ãƒãƒãƒ¼ã‚¸ãƒ‰ ID ã§èªè¨¼ã‚’è¡Œã‚ã‚Œã¦ã„ã‚‹ãŒã€é€šå¸¸ã®å¯¾è©±çš„ãªãƒ­ã‚°ã‚¤ãƒ³ã‚‚å¯èƒ½ã€‚
ãªãŠã€ãƒãƒãƒ¼ã‚¸ãƒ‰ ID ã‚’ä½¿ã†å ´åˆã€äº‹å‰ã«å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ  ãƒãƒãƒ¼ã‚¸ãƒ‰ IDã«å¯¾ã—ãƒ­ãƒ¼ãƒ«ã®ä»˜ä¸ãŒå¿…è¦ã€‚[^7]


é©å½“ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹ãªã©

```bash
azureuser@clivm:~$ az storage account create --name sa202309211 --resource-group labrmpl
```

ä½µã›ã¦å–ã£ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’ã¿ã‚‹ã¨ã€
ç¢ºã‹ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«åå‰è§£æ±ºã•ã‚Œã¦é€šä¿¡ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

![Alt text](/images/1f3283a973bd69/image-3.png)

## ã¾ã¨ã‚

* ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ã‚’åˆ¶é™ã—ã¦ã„ã‚‹ç’°å¢ƒã§ã‚‚Azure CLIã‚’åˆ©ç”¨ã§ããã†
  * ãŸã ã—ã€AKSã‚„Azure Bastionã¯ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã®ã§æ³¨æ„
* ç¾æ™‚ç‚¹ã§ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç„¡åŠ¹ã«ã§ããªã„

[^1]: [API ã‚’ä½¿ç”¨ã—ã¦ Azure ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/create-private-link-access-commands?tabs=azure-cli)
[^2]: [Azure Resource Manager ã¨ã¯](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/overview#consistent-management-layer)
[^3]: [ARM API ã¸ã® Private Link çµŒç”±æ¥ç¶šã‚’ Azure CLI ã§è©¦ã—ã¦ã¿ãŸ](https://zenn.dev/tomot/articles/342ddb164aa459)
[^4]: [å¿…è¦ãªã‚¢ã‚¯ã‚»ã‚¹è¨±å¯](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/create-private-link-access-commands?tabs=azure-cli#required-permissions)
[^5]: [Azure ã®ã™ã¹ã¦ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¨ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç®¡ç†ã™ã‚‹ç›®çš„ã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹](https://learn.microsoft.com/ja-jp/azure/role-based-access-control/elevate-access-global-admin)
[^6]: [Azure CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://learn.microsoft.com/ja-jp/cli/azure/install-azure-cli-linux?pivots=apt)
[^7]: [GitHub Issue #36664](https://github.com/MicrosoftDocs/azure-docs/issues/36664)