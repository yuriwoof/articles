---
title: "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒªãƒ³ã‚¯çµŒç”±ã§Azure CLIã‚ˆã‚Šæ“ä½œ"
emoji: "ğŸš§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Azure", "Azure CLI"]
published: false
---

å¤–éƒ¨é€šä¿¡è¦ä»¶ãŒå³ã—ã„ç’°å¢ƒã§åˆã£ãŸã‚Šã™ã‚‹å ´åˆã§ã‚‚ä½•ã¨ã‹Azure CLI/Azure PowerShellã‚’ä½¿ã„ãŸã„ã¨ã„ã†è¦æœ›ã¯ã‚ã‚Šã€ä»¥ä¸‹ã®å†…å®¹ã‚’æ‰‹å…ƒã§ç¢ºèªã‚’è¡Œã£ãŸãŸã‚è‡ªåˆ†å®›ã¦ã®ãƒ¡ãƒ¢ã¨ã—ã¦æ®‹ã—ã¦ãŠãã€‚

[API ã‚’ä½¿ç”¨ã—ã¦ Azure ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/create-private-link-access-commands?tabs=azure-cli)

Azure ãƒãƒ¼ã‚¿ãƒ«ã®æ“ä½œã‚’å«ã‚ã€Azure APIã«ã‚ˆã‚‹æ“ä½œã¯ã™ã¹ã¦Azure Resource Manager (ä»¥é™ã€ARM)ã‚’é€šã—ã¦è¡Œã‚ã‚Œã‚‹ã€‚

![Azure Resource Manager](image.png)
å‡ºå…¸å…ƒ; [Azure Resource Manager ã¨ã¯](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/overview#consistent-management-layer)

æ—¢ã«å…ˆäººã®æ–¹ãŒç¯‰ã„ãŸè³‡ç”£ãŒå¤§åˆ†å‚è€ƒã«ãªã£ãŸã®ã§ã“ã“ã«ã”ç´¹ä»‹ã€‚

https://zenn.dev/tomot/articles/342ddb164aa459

## å‰æº–å‚™

[å¿…è¦ãªã‚¢ã‚¯ã‚»ã‚¹è¨±å¯](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/create-private-link-access-commands?tabs=azure-cli#required-permissions)ã«ã‚ã‚‹ã‚ˆã†ã«ã€ãƒ«ãƒ¼ãƒˆç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«å¯¾ã—ã¦æ‰€æœ‰è€…ã¾ãŸã¯å…±åŒç®¡ç†è€…æ¨©é™ã‚’æŒã¤å¿…è¦ãŒã‚ã‚‹ã€‚

ãã®ãŸã‚ã«ã¯ã€æ“ä½œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ˜‡æ ¼ã•ã›ã€ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚

[Azure ã®ã™ã¹ã¦ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¨ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç®¡ç†ã™ã‚‹ç›®çš„ã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹](https://learn.microsoft.com/ja-jp/azure/role-based-access-control/elevate-access-global-admin)

![Alt text](image-2.png)

ãã®å¾Œã€ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦ã‚’è¡Œã†ã€‚

```bash
az role assignment create --assignee "<ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«å" --role Owner --scope "/providers/Microsoft.Management/managementGroups/<ãƒ†ãƒŠãƒ³ãƒˆID>"
```

## è¨­å®š

ä»Šå›ã¯äºˆã‚ `labrmpl` ã¨ã„ã†åå‰ã®ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ãŠã‚Šã€ãã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒªãƒ³ã‚¯ã®ä½œæˆ

```bash
$ az resourcemanagement private-link create -g labrmpl -n labrmpl -l japaneast
{
  "id": "/subscriptions/<ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID>/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl",
  "location": "japaneast",
  "name": "labrmpl",
  "properties": {
    "privateEndpointConnections": []
  },
  "resourceGroup": "labrmpl",
  "type": "Microsoft.Authorization/resourceManagementPrivateLinks"
}
```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒªãƒ³ã‚¯é–¢é€£ä»˜ã‘ã®ä½œæˆ

åå‰ã¯GUIDã®å½¢å¼ã‚’å–ã‚‹ãŸã‚ã€äºˆã‚ `uuidgen` ã‚³ãƒãƒ³ãƒ‰ãªã©ã§ç”Ÿæˆã—ã¦ãŠãã€‚ã¾ãŸã€`--public-network-access` ç¾æ™‚ç‚¹ã§ã¯ `enabled` ã—ã‹æŒ‡å®šã§ããªã„ (æã‚‰ã `disabled` ãŒæŒ‡å®šã§ãã‚Œã°ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã§ãã‚‹æƒ³å®šã ãŒã€ãƒ‡ãƒƒãƒˆãƒ­ãƒƒã‚¯ã‚’æ‹›ããã†...)

```bash
$ az private-link association create --management-group-id <ãƒ†ãƒŠãƒ³ãƒˆ ID> --name <ç”¨æ„ã—ãŸGUID> --privatelink /subscriptions/<ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID>/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl --public-network-access enabled
{
  "id": "/providers/Microsoft.Management/managementGroups/75b3f912-84d2-4c53-9f80-cfaaba22a184/providers/Microsoft.Authorization/privateLinkAssociations/818b738f-af57-422a-9e50-fe2ab9b2a925",
  "name": "818b738f-af57-422a-9e50-fe2ab9b2a925",
  "properties": {
    "privateLink": "/subscriptions/c59b26e2-271e-4d33-b01f-701ede000c1f/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl",
    "publicNetworkAccess": "Enabled",
    "scope": "/providers/Microsoft.Management/managementGroups/75b3f912-84d2-4c53-9f80-cfaaba22a184",
    "tenantId": "75b3f912-84d2-4c53-9f80-cfaaba22a184"
  },
  "type": "Microsoft.Authorization/privateLinkAssociations"
}
```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã€ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œæˆã™ã‚‹ã€‚

```bash
$ az network vnet create -g labrmpl -l japaneast -n clivnet --address-prefixes 10.0.0.0/16 --subnet-name default --subnet-prefixes 10.0.0.0/24
```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆ
`10.0.0.4` ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

```bash
$ id=$(az resourcemanagement private-link show -g labrmpl -n labrmpl --query 'id' -o tsv)
$ az network private-endpoint create --connection-name rmplconnect -n rmplpe --private-connection-resource-id $id -g labrmpl --subnet default --group-id ResourceManagement --vnet-name clivnet

...(çœç•¥)...

  "customDnsConfigs": [
    {
      "fqdn": "management.azure.com",
      "ipAddresses": [
        "10.0.0.4"
      ]
    },
    {
      "fqdn": "edge.management.azure.com",
      "ipAddresses": [
        "10.0.0.4"
      ]
    }
  ],

...(çœç•¥)...

```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ DNS ã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆ

```bash
$ az network private-dns zone create -g labrmpl -n "privatelink.azure.com"
$ az network private-dns link vnet create -g labrmpl -z "privatelink.azure.com" -n dns-link -v clivnet -e false
$ az network private-endpoint dns-zone-group create -g labrmpl --endpoint-name rmplpe -n zone-group --private-dns-zone "privatelink.azure.com" --zone-name rmpl

...(çœç•¥)...
      "recordSets": [
        {
          "fqdn": "management.privatelink.azure.com",
          "ipAddresses": [
            "10.0.0.4"
          ],
          "provisioningState": "Succeeded",
          "recordSetName": "management",
          "recordType": "A",
          "ttl": 10
        },
        {
          "fqdn": "edge.management.privatelink.azure.com",
          "ipAddresses": [
            "10.0.0.4"
          ],
          "provisioningState": "Succeeded",
          "recordSetName": "edge.management",
          "recordType": "A",
          "ttl": 10
        }
      ]
    }
  ],

...(çœç•¥)...
```

## ç¢ºèª

ã“ã“ã‹ã‚‰ã¯ç¢ºèªã®ãŸã‚ã€ä»®æƒ³ãƒã‚·ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—å‹•ä½œã‚’è¦‹ã¦ã¿ã‚‹ã€‚

```bash
$ az vm create -g labrmpl -n clivm --image Ubuntu2204 --vnet-name clivnet --subnet default --admin-username azureuser --ssh-key-value ~/.ssh/id_rsa.pub
```

```bash
azureuser@clivm:~$ nslookup management.azure.com
Server:         127.0.0.53
Address:        127.0.0.53#53

Non-authoritative answer:
management.azure.com    canonical name = management.privatelink.azure.com.
Name:   management.privatelink.azure.com
Address: 10.0.0.4
```

[Azure CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://learn.microsoft.com/ja-jp/cli/azure/install-azure-cli-linux?pivots=apt)ã—ã¦æ“ä½œã‚’ç¢ºèª
å‚è€ƒã«ã—ãŸè¨˜äº‹ã«ã‚‚åˆã£ãŸé€šã‚Šã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±ã§ã¯é€šå¸¸ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒè¡Œãˆãªã„ãŸã‚ã€ä»®æƒ³ãƒã‚·ãƒ³ã®ã‚·ã‚¹ãƒ†ãƒ  ãƒãƒãƒ¼ã‚¸ãƒ‰ IDã§ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¡Œã†

```bash
azureuser@clivm:~$ az login --debug

...(çœç•¥)...
cli.azure.cli.core.sdk.policies: Request URL: 'https://management.azure.com/subscriptions?api-version=2019-11-01'
cli.azure.cli.core.sdk.policies: Request method: 'GET'
cli.azure.cli.core.sdk.policies: Request headers:
cli.azure.cli.core.sdk.policies:     'Accept': 'application/json'
cli.azure.cli.core.sdk.policies:     'x-ms-client-request-id': '6b0aa821-5829-11ee-a1ab-5d603f9e4def'
cli.azure.cli.core.sdk.policies:     'CommandName': 'login'
cli.azure.cli.core.sdk.policies:     'ParameterSetName': '--debug'
cli.azure.cli.core.sdk.policies:     'User-Agent': 'AZURECLI/2.52.0 (DEB) azsdk-python-azure-mgmt-resource/23.1.0b2 Python/3.10.10 (Linux-6.2.0-1012-azure-x86_64-with-glibc2.35)'
cli.azure.cli.core.sdk.policies:     'Authorization': '*****'
cli.azure.cli.core.sdk.policies: Request body:
cli.azure.cli.core.sdk.policies: This request has no body
urllib3.connectionpool: Starting new HTTPS connection (1): management.azure.com:443
urllib3.connectionpool: https://management.azure.com:443 "GET /subscriptions?api-version=2019-11-01 HTTP/1.1" 403 289
cli.azure.cli.core.sdk.policies: Response status: 403
...(çœç•¥)...
cli.azure.cli.core.sdk.policies: Response content:
cli.azure.cli.core.sdk.policies: {"error":{"code":"PrivateLinkAccessRestricted","message":"Request originated from private virtual network for resource '/subscriptions', but this resource can not be accessed from a private endpoint. To connect to this resource, please use the public network without a private endpoint."}}
cli.azure.cli.core.azclierror: Traceback (most recent call last):
```

ã“ã®å ´åˆã€äº‹å‰ã«å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ  ãƒãƒãƒ¼ã‚¸ãƒ‰ IDã«å¯¾ã—ãƒ­ãƒ¼ãƒ«ã®ä»˜ä¸ãŒå¿…è¦ ([å‚è€ƒ](https://github.com/MicrosoftDocs/azure-docs/issues/36664))

```bash
$ az login --identity
```

é©å½“ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹ãªã©

```bash
azureuser@clivm:~$ az storage account create --name sa202309211 --resource-group labrmpl
```

ä½µã›ã¦å–ã£ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’ã¿ã‚‹ã¨ã€
ç¢ºã‹ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«åå‰è§£æ±ºã•ã‚Œã¦é€šä¿¡ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

![Alt text](image-3.png)

