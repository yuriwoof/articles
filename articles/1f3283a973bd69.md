---
title: "プライベート リンク経由でAzure CLIより操作"
emoji: "🚧"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Azure", "Azure CLI"]
published: false
---

外部通信要件が厳しい環境で合ったりする場合でも何とかAzure CLI/Azure PowerShellを使いたいという要望はあり、以下の内容を手元で確認を行ったため自分宛てのメモとして残しておく。

[API を使用して Azure リソースを管理するためのプライベート リンクを作成する](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/create-private-link-access-commands?tabs=azure-cli)

Azure ポータルの操作を含め、Azure APIによる操作はすべてAzure Resource Manager (以降、ARM)を通して行われる。

![Azure Resource Manager](image.png)
出典元; [Azure Resource Manager とは](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/overview#consistent-management-layer)

既に先人の方が築いた資産が大分参考になったのでここにご紹介。

https://zenn.dev/tomot/articles/342ddb164aa459

## 前準備

[必要なアクセス許可](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/create-private-link-access-commands?tabs=azure-cli#required-permissions)にあるように、ルート管理グループに対して所有者または共同管理者権限を持つ必要がある。

そのためには、操作ユーザーを昇格させ、ロールの割り当てを行う必要がある。

[Azure のすべてのサブスクリプションと管理グループを管理する目的でアクセス権限を昇格させる](https://learn.microsoft.com/ja-jp/azure/role-based-access-control/elevate-access-global-admin)

![Alt text](image-2.png)

その後、ロールの割り当てを行う。

```bash
az role assignment create --assignee "<ユーザー プリンシパル名" --role Owner --scope "/providers/Microsoft.Management/managementGroups/<テナントID>"
```

## 設定

今回は予め `labrmpl` という名前のリソースグループを作成しており、そちらを使用する。

プライベート リンクの作成

```bash
$ az resourcemanagement private-link create -g labrmpl -n labrmpl -l japaneast
{
  "id": "/subscriptions/<サブスクリプション ID>/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl",
  "location": "japaneast",
  "name": "labrmpl",
  "properties": {
    "privateEndpointConnections": []
  },
  "resourceGroup": "labrmpl",
  "type": "Microsoft.Authorization/resourceManagementPrivateLinks"
}
```

プライベート リンク関連付けの作成

名前はGUIDの形式を取るため、予め `uuidgen` コマンドなどで生成しておく。また、`--public-network-access` 現時点では `enabled` しか指定できない (恐らく `disabled` が指定できればパブリックアクセスが制限できる想定だが、デットロックを招きそう...)

```bash
$ az private-link association create --management-group-id <テナント ID> --name <用意したGUID> --privatelink /subscriptions/<サブスクリプション ID>/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl --public-network-access enabled
{
  "id": "/providers/Microsoft.Management/managementGroups/75b3f912-84d2-4c53-9f80-cfaaba22a184/providers/Microsoft.Authorization/privateLinkAssociations/818b738f-af57-422a-9e50-fe2ab9b2a925",
  "name": "818b738f-af57-422a-9e50-fe2ab9b2a925",
  "properties": {
    "privateLink": "/subscriptions/c59b26e2-271e-4d33-b01f-701ede000c1f/resourceGroups/labrmpl/providers/Microsoft.Authorization/resourceManagementPrivateLinks/labrmpl",
    "publicNetworkAccess": "Enabled",
    "scope": "/providers/Microsoft.Management/managementGroups/75b3f912-84d2-4c53-9f80-cfaaba22a184",
    "tenantId": "75b3f912-84d2-4c53-9f80-cfaaba22a184"
  },
  "type": "Microsoft.Authorization/privateLinkAssociations"
}
```

プライベート エンドポイントを作成するため、仮想ネットワークを作成する。

```bash
$ az network vnet create -g labrmpl -l japaneast -n clivnet --address-prefixes 10.0.0.0/16 --subnet-name default --subnet-prefixes 10.0.0.0/24
```

プライベート エンドポイントを作成
`10.0.0.4` が割り当てられていることを確認

```bash
$ id=$(az resourcemanagement private-link show -g labrmpl -n labrmpl --query 'id' -o tsv)
$ az network private-endpoint create --connection-name rmplconnect -n rmplpe --private-connection-resource-id $id -g labrmpl --subnet default --group-id ResourceManagement --vnet-name clivnet

...(省略)...

  "customDnsConfigs": [
    {
      "fqdn": "management.azure.com",
      "ipAddresses": [
        "10.0.0.4"
      ]
    },
    {
      "fqdn": "edge.management.azure.com",
      "ipAddresses": [
        "10.0.0.4"
      ]
    }
  ],

...(省略)...

```

プライベート DNS ゾーンを作成

```bash
$ az network private-dns zone create -g labrmpl -n "privatelink.azure.com"
$ az network private-dns link vnet create -g labrmpl -z "privatelink.azure.com" -n dns-link -v clivnet -e false
$ az network private-endpoint dns-zone-group create -g labrmpl --endpoint-name rmplpe -n zone-group --private-dns-zone "privatelink.azure.com" --zone-name rmpl

...(省略)...
      "recordSets": [
        {
          "fqdn": "management.privatelink.azure.com",
          "ipAddresses": [
            "10.0.0.4"
          ],
          "provisioningState": "Succeeded",
          "recordSetName": "management",
          "recordType": "A",
          "ttl": 10
        },
        {
          "fqdn": "edge.management.privatelink.azure.com",
          "ipAddresses": [
            "10.0.0.4"
          ],
          "provisioningState": "Succeeded",
          "recordSetName": "edge.management",
          "recordType": "A",
          "ttl": 10
        }
      ]
    }
  ],

...(省略)...
```

## 確認

ここからは確認のため、仮想マシンをデプロイし動作を見てみる。

```bash
$ az vm create -g labrmpl -n clivm --image Ubuntu2204 --vnet-name clivnet --subnet default --admin-username azureuser --ssh-key-value ~/.ssh/id_rsa.pub
```

```bash
azureuser@clivm:~$ nslookup management.azure.com
Server:         127.0.0.53
Address:        127.0.0.53#53

Non-authoritative answer:
management.azure.com    canonical name = management.privatelink.azure.com.
Name:   management.privatelink.azure.com
Address: 10.0.0.4
```

[Azure CLIをインストール](https://learn.microsoft.com/ja-jp/cli/azure/install-azure-cli-linux?pivots=apt)して操作を確認
参考にした記事にも合った通り、プライベート エンドポイント経由では通常のログインが行えないため、仮想マシンのシステム マネージド IDでログインを行う

```bash
azureuser@clivm:~$ az login --debug

...(省略)...
cli.azure.cli.core.sdk.policies: Request URL: 'https://management.azure.com/subscriptions?api-version=2019-11-01'
cli.azure.cli.core.sdk.policies: Request method: 'GET'
cli.azure.cli.core.sdk.policies: Request headers:
cli.azure.cli.core.sdk.policies:     'Accept': 'application/json'
cli.azure.cli.core.sdk.policies:     'x-ms-client-request-id': '6b0aa821-5829-11ee-a1ab-5d603f9e4def'
cli.azure.cli.core.sdk.policies:     'CommandName': 'login'
cli.azure.cli.core.sdk.policies:     'ParameterSetName': '--debug'
cli.azure.cli.core.sdk.policies:     'User-Agent': 'AZURECLI/2.52.0 (DEB) azsdk-python-azure-mgmt-resource/23.1.0b2 Python/3.10.10 (Linux-6.2.0-1012-azure-x86_64-with-glibc2.35)'
cli.azure.cli.core.sdk.policies:     'Authorization': '*****'
cli.azure.cli.core.sdk.policies: Request body:
cli.azure.cli.core.sdk.policies: This request has no body
urllib3.connectionpool: Starting new HTTPS connection (1): management.azure.com:443
urllib3.connectionpool: https://management.azure.com:443 "GET /subscriptions?api-version=2019-11-01 HTTP/1.1" 403 289
cli.azure.cli.core.sdk.policies: Response status: 403
...(省略)...
cli.azure.cli.core.sdk.policies: Response content:
cli.azure.cli.core.sdk.policies: {"error":{"code":"PrivateLinkAccessRestricted","message":"Request originated from private virtual network for resource '/subscriptions', but this resource can not be accessed from a private endpoint. To connect to this resource, please use the public network without a private endpoint."}}
cli.azure.cli.core.azclierror: Traceback (most recent call last):
```

この場合、事前に対象システム マネージド IDに対しロールの付与が必要 ([参考](https://github.com/MicrosoftDocs/azure-docs/issues/36664))

```bash
$ az login --identity
```

適当にストレージ アカウントを作るなど

```bash
azureuser@clivm:~$ az storage account create --name sa202309211 --resource-group labrmpl
```

併せて取ったネットワークパケットキャプチャをみると、
確かにプライベート エンドポイントのIPアドレスに名前解決されて通信が成功していることが分かる。

![Alt text](image-3.png)

